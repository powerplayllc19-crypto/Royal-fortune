<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Fortune Casino - Premium Gaming Experience</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --gold-light: #f4e4a6;
            --purple: #4a1a6b;
            --purple-dark: #2d0d42;
            --emerald: #10b981;
            --ruby: #ef4444;
        }

        * { font-family: 'Roboto', sans-serif; }
        h1, h2, h3, .logo { font-family: 'Playfair Display', serif; }

        body {
            background: linear-gradient(135deg, #1a0a2e 0%, #16213e 50%, #0f0f23 100%);
            min-height: 100vh;
        }

        .gold-gradient {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4a6 50%, #d4af37 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-glow {
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3), inset 0 0 30px rgba(212, 175, 55, 0.1);
        }

        .btn-gold {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4a6 50%, #d4af37 100%);
            color: #1a0a2e;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(212, 175, 55, 0.6);
        }

        .btn-gold:active { transform: translateY(0); }

        .game-card {
            background: linear-gradient(145deg, rgba(74, 26, 107, 0.8), rgba(45, 13, 66, 0.9));
            border: 1px solid rgba(212, 175, 55, 0.3);
            transition: all 0.4s ease;
        }

        .game-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(212, 175, 55, 0.3);
            border-color: rgba(212, 175, 55, 0.8);
        }

        .slot-machine {
            background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            border: 4px solid #d4af37;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5), inset 0 0 30px rgba(212, 175, 55, 0.2);
        }

        .slot-reel {
            background: linear-gradient(180deg, #111 0%, #222 50%, #111 100%);
            border: 3px solid #d4af37;
            border-radius: 10px;
            overflow: hidden;
        }

        .slot-symbol {
            font-size: 3rem;
            text-align: center;
            padding: 10px 0;
            transition: transform 0.1s;
        }

        .slot-reel.spinning .slot-symbol { animation: spin 0.1s linear infinite; }

        @keyframes spin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-60px); }
        }

        .win-animation { animation: winPulse 0.5s ease infinite; }

        @keyframes winPulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }

        .jackpot-animation { animation: jackpot 0.3s ease infinite; }

        @keyframes jackpot {
            0%, 100% { transform: scale(1) rotate(-2deg); }
            50% { transform: scale(1.2) rotate(2deg); }
        }

        .roulette-wheel {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: conic-gradient(
                #e53935 0deg 9.73deg, #1a1a1a 9.73deg 19.46deg,
                #e53935 19.46deg 29.19deg, #1a1a1a 29.19deg 38.92deg,
                #e53935 38.92deg 48.65deg, #1a1a1a 48.65deg 58.38deg,
                #e53935 58.38deg 68.11deg, #1a1a1a 68.11deg 77.84deg,
                #e53935 77.84deg 87.57deg, #1a1a1a 87.57deg 97.3deg,
                #e53935 97.3deg 107.03deg, #1a1a1a 107.03deg 116.76deg,
                #e53935 116.76deg 126.49deg, #1a1a1a 126.49deg 136.22deg,
                #e53935 136.22deg 145.95deg, #1a1a1a 145.95deg 155.68deg,
                #e53935 155.68deg 165.41deg, #1a1a1a 165.41deg 175.14deg,
                #e53935 175.14deg 184.87deg, #1a1a1a 184.87deg 194.6deg,
                #e53935 194.6deg 204.33deg, #1a1a1a 204.33deg 214.06deg,
                #e53935 214.06deg 223.79deg, #1a1a1a 223.79deg 233.52deg,
                #e53935 233.52deg 243.25deg, #1a1a1a 243.25deg 252.98deg,
                #e53935 252.98deg 262.71deg, #1a1a1a 262.71deg 272.44deg,
                #e53935 272.44deg 282.17deg, #1a1a1a 282.17deg 291.9deg,
                #00a859 291.9deg 302.63deg, #1a1a1a 302.63deg 313.36deg,
                #00a859 313.36deg 324.09deg, #1a1a1a 324.09deg 334.82deg,
                #00a859 334.82deg 345.55deg, #1a1a1a 345.55deg 356.28deg,
                #00a859 356.28deg 360deg
            );
            border: 8px solid #d4af37;
            position: relative;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.5), inset 0 0 50px rgba(0,0,0,0.5);
        }

        .roulette-wheel::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #d4af37 0%, #8b6914 100%);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .ball {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle at 30% 30%, #fff, #ccc);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            background: linear-gradient(145deg, #2d2d2d, #1a1a1a);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #d4af37;
        }

        .bingo-cell {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #3d3d3d, #2a2a2a);
            border: 2px solid #555;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #d4af37;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bingo-cell:hover { border-color: #d4af37; transform: scale(1.05); }
        .bingo-cell.marked { background: linear-gradient(145deg, #d4af37, #b8960c); color: #1a0a2e; animation: bingoPop 0.3s ease; }
        .bingo-cell.bingo-winner { background: linear-gradient(145deg, #10b981, #059669); color: white; animation: bingoWin 0.5s ease infinite; }

        @keyframes bingoPop { 0%{transform:scale(1);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }
        @keyframes bingoWin { 0%,100%{transform:scale(1) rotate(0deg);} 25%{transform:scale(1.1) rotate(5deg);} 75%{transform:scale(1.1) rotate(-5deg);} }

        .called-number {
            font-size: 4rem;
            font-weight: bold;
            color: #d4af37;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.8);
            animation: numberPop 0.5s ease;
        }

        @keyframes numberPop { 0%{transform:scale(0);opacity:0;} 50%{transform:scale(1.2);} 100%{transform:scale(1);opacity:1;} }

        .playing-card {
            width: 70px;
            height: 100px;
            background: linear-gradient(145deg, #fff, #e8e8e8);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .playing-card.red { color: #e53935; }
        .playing-card.black { color: #1a1a1a; }
        .playing-card:hover { transform: translateY(-10px); }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confettiFall 3s linear forwards;
            z-index: 9999;
        }

        @keyframes confettiFall {
            0% { top: -10px; transform: rotate(0deg); opacity: 1; }
            100% { top: 100vh; transform: rotate(720deg); opacity: 0; }
        }

        .balance-display {
            background: linear-gradient(135deg, #1a0a2e, #2d1a4a);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 1.2rem;
            color: #10b981;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .nav-link { transition: all 0.3s ease; position: relative; }
        .nav-link::after { content:''; position:absolute; bottom:-5px; left:0; width:0; height:2px; background:#d4af37; transition: width 0.3s ease; }
        .nav-link:hover::after { width: 100%; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display:flex; }

        .modal-content {
            background: linear-gradient(145deg, #1a0a2e, #2d1a4a);
            border: 2px solid #d4af37;
            border-radius: 20px;
            padding: 30px;
            max-width: 560px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .bet-chip {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 4px dashed rgba(255,255,255,0.5);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .bet-chip:hover { transform: scale(1.1); }
        .bet-chip.selected { transform: scale(1.15); box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); }

        .chip-5 { background: linear-gradient(145deg, #ef4444, #b91c1c); color: white; }
        .chip-10 { background: linear-gradient(145deg, #3b82f6, #1d4ed8); color: white; }
        .chip-25 { background: linear-gradient(145deg, #10b981, #059669); color: white; }
        .chip-50 { background: linear-gradient(145deg, #8b5cf6, #6d28d9); color: white; }
        .chip-100 { background: linear-gradient(145deg, #1a1a1a, #333); color: #d4af37; }
        .chip-500 { background: linear-gradient(145deg, #d4af37, #b8960c); color: #1a0a2e; }

        .roulette-number {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .roulette-number:hover { transform: scale(1.2); z-index: 10; }
        .red-num { background: #e53935; color: white; }
        .black-num { background: #1a1a1a; color: white; }
        .green-num { background: #00a859; color: white; }

        .progress-bar { height: 10px; background: #333; border-radius: 5px; overflow:hidden; }
        .progress-fill { height:100%; background: linear-gradient(90deg, #d4af37, #f4e4a6); transition: width 0.5s ease; }

        .leaderboard-item {
            background: linear-gradient(145deg, rgba(74, 26, 107, 0.5), rgba(45, 13, 66, 0.7));
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover { border-color:#d4af37; transform: translateX(5px); }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn { from{transform:translateX(100%);opacity:0;} to{transform:translateX(0);opacity:1;} }

        .notification.success { background: linear-gradient(145deg, #10b981, #059669); }
        .notification.error { background: linear-gradient(145deg, #ef4444, #b91c1c); }
        .notification.info { background: linear-gradient(145deg, #3b82f6, #1d4ed8); }

        .wheel-of-fortune {
            width: 350px;
            height: 350px;
            border-radius: 50%;
            border: 8px solid #d4af37;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
        }

        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            transform-origin: 0% 0%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #d4af37;
            z-index: 10;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5));
        }

        /* Store */
        .store-tab { transition: all 0.2s ease; }
        .store-tab.active { background: rgba(212,175,55,0.18); border-color: rgba(212,175,55,0.6); color: #f4e4a6; }
        .price-card { border: 1px solid rgba(212,175,55,0.25); background: linear-gradient(145deg, rgba(74, 26, 107, 0.45), rgba(45, 13, 66, 0.65)); }
        .price-card:hover { border-color: rgba(212,175,55,0.8); box-shadow: 0 16px 40px rgba(0,0,0,0.35); transform: translateY(-6px); }

        /* ‚ÄúAd‚Äù banner */
        .ad-banner { background: linear-gradient(145deg, rgba(2, 6, 23, 0.65), rgba(30, 41, 59, 0.35)); border: 1px solid rgba(148,163,184,0.25); }

        /* Lock overlay */
        .locked-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            backdrop-filter: blur(2px);
        }

        /* Toggle */
        .toggle { width: 46px; height: 24px; border-radius: 999px; position: relative; background: rgba(100,116,139,0.5); border: 1px solid rgba(148,163,184,0.3); cursor: pointer; }
        .toggle::after { content:''; position:absolute; top: 2px; left: 2px; width: 20px; height: 20px; border-radius: 999px; background: white; transition: all 0.2s ease; }
        .toggle.on { background: rgba(16,185,129,0.5); border-color: rgba(16,185,129,0.6); }
        .toggle.on::after { left: 24px; background: #10b981; }
    </style>
</head>
<body class="text-white">

<header class="fixed top-0 left-0 right-0 z-50 bg-[#050512]/95 backdrop-blur-md border-b border-[#d4af37]/30">
    <div class="container mx-auto px-4 py-2 flex items-center justify-between text-xs text-gray-300">
        <div class="flex items-center space-x-3">
            <span class="px-2 py-1 rounded-full bg-emerald-600/20 text-emerald-400 border border-emerald-500/40" id="onlineStatus">‚óè Online 24/7</span>
            <span id="currentUserLabel" class="hidden sm:inline">Guest</span>
            <button id="loginToggleBtn" class="ml-2 px-2 py-1 rounded-full bg-purple-700 hover:bg-purple-600 text-[11px] font-semibold" onclick="toggleAuthPanel()">Sign in</button>
            <span id="vipClubBadge" class="hidden px-2 py-1 rounded-full bg-[#d4af37]/20 text-[#f4e4a6] border border-[#d4af37]/40 text-[11px] font-semibold">VIP Club Active</span>
        </div>
        <div class="flex items-center space-x-3">
            <span class="hidden sm:inline text-[11px] text-gray-400" id="vipLabel">VIP 0 ‚Ä¢ Bronze</span>
            <div class="w-24 h-1.5 bg-gray-700 rounded-full overflow-hidden">
                <div id="vipProgressBar" class="h-full bg-gradient-to-r from-yellow-400 to-yellow-200" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <nav class="bg-gradient-to-r from-[#1a0a2e]/95 to-[#2d1a4a]/95">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="logo text-2xl md:text-3xl gold-gradient font-bold cursor-pointer" onclick="showSection('lobby')">üëë Royal Fortune</div>

                <div class="hidden md:flex items-center space-x-6">
                    <a class="nav-link cursor-pointer" onclick="showSection('lobby')">üé∞ Lobby</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('store')">üõí Store</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('missions')">‚úÖ Missions</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('achievements')">üèÖ Achievements</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('tournaments')">üèÜ Tournaments</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('slots')">üé° Slots</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('blackjack')">üÉè Blackjack</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('roulette')">üéØ Roulette</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('bingo')">üé± Bingo</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('poker')">‚ô†Ô∏è Poker</a>
                    <a class="nav-link cursor-pointer" onclick="showSection('wheel')">üéÅ Wheel</a>
                    <a class="nav-link cursor-pointer" onclick="openVipLounge()">üëë VIP Lounge</a>
                </div>

                <div class="flex items-center space-x-3">
                    <div class="balance-display leading-tight">
                        <div class="text-sm md:text-base">üí∞ <span id="balance">1000.00</span></div>
                        <div id="regenHint" class="text-[10px] text-gray-300/80">Regen: --</div>
                    </div>
                    <button class="btn-gold px-4 py-2 rounded-full text-sm" onclick="quickBuy()">üõí Quick Buy</button>
                    <button class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-full text-sm transition" onclick="openModal('support')">Support</button>
                    <button class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-full text-sm transition" onclick="downloadApp()">üì• Download App</button>
                </div>
            </div>
        </div>
    </nav>
</header>

<!-- Auth Panel -->
<div id="authPanel" class="fixed top-[60px] right-4 z-40 w-80 max-w-[90vw] bg-gradient-to-b from-[#090922] to-[#150b2e] border border-[#d4af37]/40 rounded-2xl shadow-2xl hidden">
    <div class="p-4 border-b border-[#d4af37]/30 flex items-center justify-between">
        <div>
            <div class="text-xs uppercase tracking-wide text-gray-400">Account Center</div>
            <div class="text-sm font-semibold" id="authTitle">Sign in to save progress</div>
        </div>
        <button class="text-gray-400 hover:text-white" onclick="toggleAuthPanel()">‚úï</button>
    </div>
    <div class="p-4 space-y-3" id="authContent">
        <input id="authUsername" type="text" class="w-full bg-black/40 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Username" />
        <input id="authEmail" type="email" class="w-full bg-black/40 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Email" />
        <input id="authPassword" type="password" class="w-full bg-black/40 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Password" />
        <button class="btn-gold w-full py-2 rounded-lg text-sm" onclick="loginOrRegister()">Sign up / Sign in</button>

        <div class="pt-2 grid grid-cols-2 gap-2">
            <button class="bg-purple-700 hover:bg-purple-600 py-2 rounded-lg text-xs" onclick="showSection('store'); setStoreTab('vip'); toggleAuthPanel();">VIP Club</button>
            <button class="bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-xs" onclick="openModal('support'); toggleAuthPanel();">Support</button>
        </div>

        <div class="pt-2 flex items-center justify-between">
            <button class="bg-blue-600 hover:bg-blue-700 py-2 px-3 rounded-lg text-xs" onclick="sendMagicLink()">Send Magic Link</button>
            <button class="bg-gray-800 hover:bg-gray-700 py-2 px-3 rounded-lg text-xs" onclick="forgotPassword()">Forgot?</button>
        </div>

        <button id="logoutBtn" class="w-full py-2 rounded-lg text-sm bg-red-600 hover:bg-red-700 hidden" onclick="logout()">Logout</button>

        <p class="text-[11px] text-gray-500">This app uses Supabase Auth + Postgres. On GitHub Pages, the Supabase anon key is public by design. Protect data with RLS policies.</p>
    </div>
    <div class="p-3 border-t border-[#d4af37]/20 text-[11px] text-gray-500 space-y-1">
        <div class="flex justify-between"><span>Total wagered:</span><span id="authTotalWagered">$0.00</span></div>
        <div class="flex justify-between"><span>VIP Club:</span><span id="authVipClubStatus">Inactive</span></div>
    </div>
</div>

<!-- Mobile Navigation -->
<div class="fixed bottom-0 left-0 right-0 md:hidden z-50 bg-gradient-to-t from-[#1a0a2e] to-transparent pt-10 pb-4">
    <div class="flex justify-around">
        <button class="p-3 bg-purple-900/80 rounded-full" onclick="showSection('lobby')">üè†</button>
        <button class="p-3 bg-purple-900/80 rounded-full" onclick="showSection('store')">üõí</button>
        <button class="p-3 bg-purple-900/80 rounded-full" onclick="showSection('missions')">‚úÖ</button>
        <button class="p-3 bg-purple-900/80 rounded-full" onclick="showSection('bingo')">üé±</button>
        <button class="p-3 bg-purple-900/80 rounded-full" onclick="showSection('tournaments')">üèÜ</button>
    </div>
</div>

<main class="pt-28 pb-24 md:pb-10 px-4">

    <!-- Lobby Section -->
    <section id="lobby" class="section">
        <div class="text-center mb-10">
            <h1 class="text-5xl md:text-7xl gold-gradient font-bold mb-4">Welcome to Royal Fortune</h1>
            <p class="text-xl text-gray-300">Premium social casino experience ‚Ä¢ Play with virtual coins</p>
            <div class="mt-6 flex justify-center items-center space-x-8">
                <div class="text-center">
                    <div class="text-3xl font-bold text-[#d4af37]">$2.5M+</div>
                    <div class="text-gray-400">Total Paid Out</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-[#10b981]">50K+</div>
                    <div class="text-gray-400">Active Players</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-[#8b5cf6]">24/7</div>
                    <div class="text-gray-400">Live Support</div>
                </div>
            </div>
        </div>

        <!-- Ad banner (hidden for VIP Club) -->
        <div id="adBanner" class="max-w-5xl mx-auto mb-8 ad-banner rounded-2xl p-5">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div>
                    <div class="text-xs uppercase tracking-wider text-gray-400">Sponsored ‚Ä¢ Rewarded</div>
                    <div class="text-lg font-semibold">Watch a short video ‚Üí earn <span class="text-emerald-400 font-bold">500 coins</span></div>
                    <div class="text-[12px] text-gray-400">(VIP Club removes ads and gives a larger daily bonus.)</div>
                </div>
                <div class="flex gap-2">
                    <button class="bg-emerald-600 hover:bg-emerald-700 px-5 py-2 rounded-lg font-semibold" onclick="watchAdForCoins()">‚ñ∂ Watch</button>
                    <button class="bg-purple-700 hover:bg-purple-600 px-5 py-2 rounded-lg font-semibold" onclick="showSection('store'); setStoreTab('vip');">Go VIP</button>
                </div>
            </div>
        </div>

        <!-- Jackpot Banner -->
        <div class="max-w-4xl mx-auto mb-10 card-glow rounded-2xl p-8 bg-gradient-to-r from-purple-900/80 to-pink-900/80 text-center">
            <div class="text-lg text-[#d4af37] mb-2">üèÜ MEGA PROGRESSIVE JACKPOT üèÜ</div>
            <div class="text-6xl md:text-8xl font-bold gold-gradient jackpot-animation" id="jackpot">$1,247,893.45</div>
            <div class="mt-4 text-gray-300">Growing every second! Play any slot game for a chance to win!</div>
        </div>

        <!-- Game Categories -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">
            <div class="game-card rounded-xl p-6 cursor-pointer" onclick="showSection('slots')">
                <div class="text-5xl mb-4 text-center">üé∞</div>
                <h3 class="text-xl font-bold text-center gold-gradient">Slots</h3>
                <p class="text-gray-400 text-center text-sm mt-2">100+ Games ‚Ä¢ RTP 95-97%</p>
                <div class="mt-3 flex justify-center"><span class="bg-red-500/20 text-red-400 px-2 py-1 rounded text-xs">HOT</span></div>
            </div>
            <div class="game-card rounded-xl p-6 cursor-pointer" onclick="showSection('blackjack')">
                <div class="text-5xl mb-4 text-center">üÉè</div>
                <h3 class="text-xl font-bold text-center gold-gradient">Blackjack</h3>
                <p class="text-gray-400 text-center text-sm mt-2">Classic ‚Ä¢ RTP 99.5%</p>
                <div class="mt-3 flex justify-center"><span class="bg-green-500/20 text-green-400 px-2 py-1 rounded text-xs">LOW HOUSE EDGE</span></div>
            </div>
            <div class="game-card rounded-xl p-6 cursor-pointer" onclick="showSection('roulette')">
                <div class="text-5xl mb-4 text-center">üéØ</div>
                <h3 class="text-xl font-bold text-center gold-gradient">Roulette</h3>
                <p class="text-gray-400 text-center text-sm mt-2">European ‚Ä¢ RTP 97.3%</p>
            </div>
            <div class="game-card rounded-xl p-6 cursor-pointer" onclick="showSection('bingo')">
                <div class="text-5xl mb-4 text-center">üé±</div>
                <h3 class="text-xl font-bold text-center gold-gradient">Bingo</h3>
                <p class="text-gray-400 text-center text-sm mt-2">Live Rooms ‚Ä¢ Big Prizes</p>
                <div class="mt-3 flex justify-center"><span class="bg-purple-500/20 text-purple-400 px-2 py-1 rounded text-xs">POPULAR</span></div>
            </div>
            <div class="game-card rounded-xl p-6 cursor-pointer" onclick="showSection('poker')">
                <div class="text-5xl mb-4 text-center">‚ô†Ô∏è</div>
                <h3 class="text-xl font-bold text-center gold-gradient">Video Poker</h3>
                <p class="text-gray-400 text-center text-sm mt-2">Jacks or Better ‚Ä¢ RTP 99.5%</p>
            </div>
            <div class="game-card rounded-xl p-6 cursor-pointer" onclick="showSection('wheel')">
                <div class="text-5xl mb-4 text-center">üéÅ</div>
                <h3 class="text-xl font-bold text-center gold-gradient">Wheel of Fortune</h3>
                <p class="text-gray-400 text-center text-sm mt-2">Daily Spins ‚Ä¢ Free Rewards</p>
                <div class="mt-3 flex justify-center"><span class="bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded text-xs">FREE</span></div>
            </div>
            <div class="game-card rounded-xl p-6 cursor-pointer" onclick="showSection('nmSlots')">
                <div class="text-5xl mb-4 text-center">üèúÔ∏è</div>
                <h3 class="text-xl font-bold text-center gold-gradient">New Mexico Slots</h3>
                <p class="text-gray-400 text-center text-sm mt-2">Roadrunner Reels ‚Ä¢ Zia Jackpots</p>
                <div class="mt-3 flex justify-center"><span class="bg-amber-500/20 text-amber-300 px-2 py-1 rounded text-xs">FEATURED</span></div>
            </div>
            <div class="game-card rounded-xl p-6 cursor-pointer" onclick="openVipLounge()">
                <div class="text-5xl mb-4 text-center">üëë</div>
                <h3 class="text-xl font-bold text-center gold-gradient">VIP Lounge</h3>
                <p class="text-gray-400 text-center text-sm mt-2">Exclusive Games ‚Ä¢ VIP Benefits</p>
                <div class="mt-3 flex justify-center"><span class="bg-[#d4af37]/20 text-[#f4e4a6] px-2 py-1 rounded text-xs">VIP CLUB</span></div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="max-w-4xl mx-auto mt-14">
            <h2 class="text-3xl font-bold gold-gradient text-center mb-8">üèÜ Top Winners Today</h2>
            <div class="space-y-4" id="leaderboard">
                <div class="leaderboard-item flex items-center justify-between">
                    <div class="flex items-center space-x-4"><span class="text-2xl">ü•á</span><span class="font-bold">GoldPlayer99</span></div>
                    <span class="text-green-400 font-bold">+$12,450.00</span>
                </div>
                <div class="leaderboard-item flex items-center justify-between">
                    <div class="flex items-center space-x-4"><span class="text-2xl">ü•à</span><span class="font-bold">LuckyCharm</span></div>
                    <span class="text-green-400 font-bold">+$8,725.50</span>
                </div>
                <div class="leaderboard-item flex items-center justify-between">
                    <div class="flex items-center space-x-4"><span class="text-2xl">ü•â</span><span class="font-bold">SlotKing</span></div>
                    <span class="text-green-400 font-bold">+$5,280.00</span>
                </div>
            </div>
        </div>

        <!-- Daily Rewards Banner -->
        <div class="max-w-4xl mx-auto mt-14 card-glow rounded-2xl p-8 bg-gradient-to-r from-emerald-900/80 to-teal-900/80">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div>
                    <h3 class="text-2xl font-bold gold-gradient mb-2">üéÅ Daily Login Bonus</h3>
                    <p class="text-gray-300">Claim free coins every day! Streak bonus up to 7x! <span id="vipDailyBonusHint" class="hidden text-emerald-300 font-semibold">VIP Club doubles bonuses</span></p>
                </div>
                <button id="dailyBonusBtn" class="btn-gold px-8 py-4 rounded-full text-xl" onclick="claimDailyBonus()">
                    Claim <span id="dailyBonusAmount">500</span> Coins
                </button>
            </div>
        </div>
    </section>

    <!-- Store Section -->
    <section id="store" class="section hidden">
        <div class="max-w-6xl mx-auto">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold gold-gradient">üõí Store</h2>
                <p class="text-gray-300">Buy virtual coins, join VIP Club, and unlock premium features.</p>
            </div>

            <div class="max-w-3xl mx-auto flex items-center justify-center gap-2 mb-8">
                <button id="tabCoins" class="store-tab active px-4 py-2 rounded-full border border-gray-700 bg-black/30" onclick="setStoreTab('coins')">Coins</button>
                <button id="tabVip" class="store-tab px-4 py-2 rounded-full border border-gray-700 bg-black/30" onclick="setStoreTab('vip')">VIP Club</button>
                <button id="tabSpecials" class="store-tab px-4 py-2 rounded-full border border-gray-700 bg-black/30" onclick="setStoreTab('specials')">Specials</button>
            </div>

            <!-- Coins -->
            <div id="storeCoins" class="">
                <!-- Low balance prompt -->
                <div id="lowBalancePrompt" class="hidden max-w-5xl mx-auto mb-6 bg-red-900/30 border border-red-500/30 rounded-2xl p-5">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                        <div>
                            <div class="text-xs uppercase tracking-wider text-red-200/80">Heads up</div>
                            <div class="text-lg font-semibold">You‚Äôre running low on coins</div>
                            <div class="text-sm text-red-200/70">Grab a quick pack or claim daily bonus to keep playing.</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn-gold px-5 py-2 rounded-xl" onclick="startCheckout('pack','starter')">Buy Starter</button>
                            <button class="bg-purple-700 hover:bg-purple-600 px-5 py-2 rounded-xl" onclick="showSection('lobby')">Claim Daily</button>
                        </div>
                    </div>
                </div>

                <!-- Featured / Limited offers -->
                <div class="max-w-5xl mx-auto mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="price-card rounded-2xl p-5 border border-[#d4af37]/35 relative overflow-hidden">
                        <div class="absolute -top-3 left-4 px-3 py-1 text-xs rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-500/40">HOT DEAL</div>
                        <div class="text-xl font-bold">Daily Booster</div>
                        <div class="text-sm text-gray-300 mt-1">Limited bonus pack (refreshes daily)</div>
                        <div class="mt-5 flex items-end justify-between">
                            <div>
                                <div class="text-3xl font-bold text-emerald-300">25,000</div>
                                <div class="text-xs text-gray-400">+ 5,000 bonus</div>
                            </div>
                            <button class="btn-gold px-5 py-2 rounded-xl" onclick="startCheckout('pack','daily')">$7.99</button>
                        </div>
                    </div>

                    <div class="price-card rounded-2xl p-5 border border-amber-300/40 relative overflow-hidden">
                        <div class="absolute -top-3 left-4 px-3 py-1 text-xs rounded-full bg-[#d4af37]/25 text-[#f4e4a6] border border-[#d4af37]/40">BEST VALUE</div>
                        <div class="text-xl font-bold">Mega Bundle</div>
                        <div class="text-sm text-gray-300 mt-1">Biggest bonus for grinders</div>
                        <div class="mt-5 flex items-end justify-between">
                            <div>
                                <div class="text-3xl font-bold text-emerald-300">150,000</div>
                                <div class="text-xs text-gray-400">+ 50,000 bonus</div>
                            </div>
                            <button class="btn-gold px-5 py-2 rounded-xl" onclick="startCheckout('pack','mega')">$29.99</button>
                        </div>
                    </div>

                    <div class="price-card rounded-2xl p-5 border border-purple-400/30 relative overflow-hidden">
                        <div class="absolute -top-3 left-4 px-3 py-1 text-xs rounded-full bg-purple-500/20 text-purple-200 border border-purple-500/40">VIP UPSELL</div>
                        <div class="text-xl font-bold">VIP Club</div>
                        <div class="text-sm text-gray-300 mt-1">Ad-free + 2x daily bonus + faster regen</div>
                        <div class="mt-5 flex items-end justify-between">
                            <div>
                                <div class="text-3xl font-bold gold-gradient">$9.99</div>
                                <div class="text-xs text-gray-400">per month</div>
                            </div>
                            <button class="bg-purple-700 hover:bg-purple-600 px-5 py-2 rounded-xl font-semibold" onclick="setStoreTab('vip')">See VIP</button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="price-card rounded-2xl p-6 transition">
                        <div class="flex items-center justify-between">
                            <div class="text-xl font-bold">Starter Pack</div>
                            <span class="px-2 py-1 text-xs rounded-full bg-red-500/20 text-red-300 border border-red-500/30">LIMITED</span>
                        </div>
                        <div class="mt-2 text-gray-300 text-sm">Perfect for new players</div>
                        <div class="mt-6">
                            <div class="text-4xl font-bold text-emerald-300">10,000</div>
                            <div class="text-gray-400 text-sm">coins</div>
                        </div>
                        <div class="mt-5 flex items-center justify-between">
                            <div class="text-2xl font-bold">$2.99</div>
                            <button class="btn-gold px-5 py-2 rounded-xl" onclick="startCheckout('pack','starter')">Buy</button>
                        </div>
                    </div>

                    <div class="price-card rounded-2xl p-6 transition relative">
                        <div class="absolute -top-3 right-4 px-3 py-1 text-xs rounded-full bg-[#d4af37]/25 text-[#f4e4a6] border border-[#d4af37]/40">BEST VALUE</div>
                        <div class="text-xl font-bold">Royal Bundle</div>
                        <div class="mt-2 text-gray-300 text-sm">Extra bonus coins included</div>
                        <div class="mt-6">
                            <div class="text-4xl font-bold text-emerald-300">60,000</div>
                            <div class="text-gray-400 text-sm">+ 10,000 bonus</div>
                        </div>
                        <div class="mt-5 flex items-center justify-between">
                            <div class="text-2xl font-bold">$19.99</div>
                            <button class="btn-gold px-5 py-2 rounded-xl" onclick="startCheckout('pack','royal')">Buy</button>
                        </div>
                    </div>

                    <div class="price-card rounded-2xl p-6 transition">
                        <div class="text-xl font-bold">Whale Chest</div>
                        <div class="mt-2 text-gray-300 text-sm">For high rollers</div>
                        <div class="mt-6">
                            <div class="text-4xl font-bold text-emerald-300">200,000</div>
                            <div class="text-gray-400 text-sm">+ 60,000 bonus</div>
                        </div>
                        <div class="mt-5 flex items-center justify-between">
                            <div class="text-2xl font-bold">$49.99</div>
                            <button class="btn-gold px-5 py-2 rounded-xl" onclick="startCheckout('pack','whale')">Buy</button>
                        </div>
                    </div>
                </div>

                <div class="max-w-5xl mx-auto mt-8 bg-black/30 border border-gray-700/50 rounded-2xl p-6">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                        <div>
                            <div class="text-xs uppercase tracking-wider text-gray-400">Tip</div>
                            <div class="text-lg font-semibold">Run out of coins?</div>
                            <div class="text-gray-400 text-sm">VIP Club includes faster coin regeneration and bigger daily bonuses to keep you playing.</div>
                        </div>
                        <button class="bg-purple-700 hover:bg-purple-600 px-6 py-3 rounded-xl font-semibold" onclick="setStoreTab('vip')">See VIP Club</button>
                    </div>
                </div>
            </div>

            <!-- VIP -->
            <div id="storeVip" class="hidden">
                <div class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="price-card rounded-2xl p-6 lg:col-span-2 transition">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="text-2xl font-bold gold-gradient">üëë VIP Club</div>
                                <div class="text-gray-300 mt-1">$9.99/month ‚Ä¢ Cancel anytime</div>
                            </div>
                            <div id="vipClubStatusPill" class="px-3 py-1 rounded-full text-xs border border-gray-600 bg-black/30 text-gray-300">Inactive</div>
                        </div>

                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="bg-black/30 border border-gray-700/50 rounded-xl p-4">
                                <div class="font-bold">üéÅ Daily bonus multiplier</div>
                                <div class="text-gray-400">Daily bonuses are <span class="text-emerald-300 font-semibold">2x</span> while VIP Club is active.</div>
                            </div>
                            <div class="bg-black/30 border border-gray-700/50 rounded-xl p-4">
                                <div class="font-bold">üö´ Ad-free experience</div>
                                <div class="text-gray-400">Removes rewarded/interstitial placements in the UI.</div>
                            </div>
                            <div class="bg-black/30 border border-gray-700/50 rounded-xl p-4">
                                <div class="font-bold">üîí Exclusive games</div>
                                <div class="text-gray-400">Unlock the <span class="text-[#f4e4a6] font-semibold">VIP Lounge</span> with VIP-only games and features.</div>
                            </div>
                            <div class="bg-black/30 border border-gray-700/50 rounded-xl p-4">
                                <div class="font-bold">‚ö° Faster coin regeneration</div>
                                <div class="text-gray-400">Higher regen rate + higher coin cap while idle.</div>
                            </div>
                            <div class="bg-black/30 border border-gray-700/50 rounded-xl p-4 md:col-span-2">
                                <div class="font-bold">üéß Priority support</div>
                                <div class="text-gray-400">VIP tickets are tagged and routed first (demo behavior in this UI).</div>
                            </div>
                        </div>

                        <div class="mt-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                            <div class="text-gray-400 text-sm">
                                Status: <span id="vipClubStatusText" class="text-white font-semibold">Inactive</span>
                                <span id="vipClubExpiry" class="block text-[12px] text-gray-500">‚Äî</span>
                            </div>
                            <div class="flex gap-2">
                                <button id="vipJoinBtn" class="btn-gold px-6 py-3 rounded-xl" onclick="startCheckout('vip','vipclub')">Join VIP Club</button>
                                <button id="vipCancelBtn" class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-xl hidden" onclick="cancelVipClub()">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="price-card rounded-2xl p-6 transition relative overflow-hidden">
                        <div class="text-xs uppercase tracking-wider text-gray-400">Settings</div>
                        <div class="mt-2 flex items-center justify-between">
                            <div>
                                <div class="font-bold">Ad-free mode</div>
                                <div class="text-[12px] text-gray-400">Auto enabled with VIP Club</div>
                            </div>
                            <div id="adFreeToggle" class="toggle" onclick="toggleAdFree()" title="Toggle ad-free (VIP only)"></div>
                        </div>

                        <div class="mt-5 border-t border-gray-700/50 pt-4 text-sm">
                            <div class="font-bold">VIP Welcome Gift</div>
                            <div class="text-gray-400">Get <span class="text-emerald-300 font-semibold">+5,000 coins</span> immediately upon joining.</div>
                        </div>

                        <div class="mt-5 border-t border-gray-700/50 pt-4 text-sm">
                            <div class="font-bold">VIP Lounge Access</div>
                            <div class="text-gray-400">Play exclusive games & higher limits.</div>
                            <button class="bg-purple-700 hover:bg-purple-600 w-full mt-3 py-2 rounded-xl font-semibold" onclick="openVipLounge()">Open VIP Lounge</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Specials -->
            <div id="storeSpecials" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="price-card rounded-2xl p-6 transition">
                        <div class="text-xl font-bold">üé® Desert Theme Pack</div>
                        <div class="text-gray-400 text-sm mt-1">Cosmetic skins for New Mexico vibes</div>
                        <div class="mt-6">
                            <div class="text-4xl font-bold text-emerald-300">Unlocked</div>
                            <div class="text-gray-400 text-sm">(Demo included)</div>
                        </div>
                        <div class="mt-5 flex items-center justify-between">
                            <div class="text-2xl font-bold">$0.00</div>
                            <button class="bg-gray-700 px-5 py-2 rounded-xl cursor-not-allowed" disabled>Included</button>
                        </div>
                    </div>

                    <div class="price-card rounded-2xl p-6 transition">
                        <div class="text-xl font-bold">üé∞ VIP Boost Token</div>
                        <div class="text-gray-400 text-sm mt-1">Adds +10 VIP XP per spin (cosmetic progression)</div>
                        <div class="mt-6">
                            <div class="text-4xl font-bold text-emerald-300">+1,000</div>
                            <div class="text-gray-400 text-sm">VIP XP</div>
                        </div>
                        <div class="mt-5 flex items-center justify-between">
                            <div class="text-2xl font-bold">$4.99</div>
                            <button class="btn-gold px-5 py-2 rounded-xl" onclick="startCheckout('item','vipxp')">Buy</button>
                        </div>
                    </div>

                    <div class="price-card rounded-2xl p-6 transition">
                        <div class="text-xl font-bold">üé± Bingo Auto-Dauber</div>
                        <div class="text-gray-400 text-sm mt-1">Auto-marks called numbers on your card</div>
                        <div class="mt-6">
                            <div class="text-4xl font-bold text-emerald-300">ON</div>
                            <div class="text-gray-400 text-sm">for 24h</div>
                        </div>
                        <div class="mt-5 flex items-center justify-between">
                            <div class="text-2xl font-bold">$2.99</div>
                            <button class="btn-gold px-5 py-2 rounded-xl" onclick="startCheckout('item','autodauber')">Buy</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Missions Section -->
    <section id="missions" class="section hidden">
        <div class="max-w-5xl mx-auto">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold gold-gradient">‚úÖ Missions</h2>
                <p class="text-gray-300">Complete missions to earn coins, VIP XP, and boosters. VIP Club gets bigger rewards.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-black/30 border border-gray-700/50 rounded-2xl p-6 lg:col-span-2">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold gold-gradient">Your Missions</h3>
                        <button class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-xs" onclick="renderMissions()">Refresh</button>
                    </div>
                    <div class="mt-4" id="missionsList"></div>
                </div>

                <div class="bg-black/30 border border-gray-700/50 rounded-2xl p-6">
                    <h3 class="text-xl font-bold gold-gradient">Boosters</h3>
                    <div class="mt-3 space-y-3 text-sm text-gray-300">
                        <div class="bg-purple-900/40 border border-purple-500/30 rounded-xl p-4">
                            <div class="font-semibold">üéØ Mission Multiplier</div>
                            <div class="text-gray-400 text-[12px]">VIP Club doubles many mission rewards automatically.</div>
                        </div>
                        <div class="bg-purple-900/40 border border-purple-500/30 rounded-xl p-4">
                            <div class="font-semibold">üéÅ Daily bonus synergy</div>
                            <div class="text-gray-400 text-[12px]">Claim daily bonus, then complete a mission loop to maximize retention and value.</div>
                        </div>
                        <button class="btn-gold w-full py-3 rounded-xl" onclick="showSection('store'); setStoreTab('specials');">Shop Boosters</button>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-gray-400 text-sm">
                <div class="bg-black/20 border border-gray-700/40 rounded-xl p-4">
                    <div class="font-semibold text-white">Server-side migration plan (Supabase)</div>
                    <div class="text-[12px] mt-1">These missions currently run client-side for GitHub Pages. When ready, store progress in Supabase tables and enforce rewards using RLS + RPC/Edge Functions.</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Achievements Section -->
    <section id="achievements" class="section hidden">
        <div class="max-w-6xl mx-auto">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold gold-gradient">üèÖ Achievements</h2>
                <p class="text-gray-300">Long-term goals to keep players engaged. Designed to migrate to Supabase easily.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-black/30 border border-gray-700/50 rounded-2xl p-6 lg:col-span-2">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold gold-gradient">Trophies</h3>
                        <button class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-xs" onclick="renderAchievements()">Refresh</button>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4" id="achievementsList"></div>
                </div>

                <div class="bg-black/30 border border-gray-700/50 rounded-2xl p-6">
                    <h3 class="text-xl font-bold gold-gradient">Rewards</h3>
                    <div class="mt-3 space-y-3 text-sm text-gray-300">
                        <div class="bg-emerald-900/30 border border-emerald-500/30 rounded-xl p-4">
                            <div class="font-semibold">üí∞ Coin bonuses</div>
                            <div class="text-gray-400 text-[12px]">Claim coins for major milestones. VIP Club helps you reach them faster with regen and perks.</div>
                        </div>
                        <div class="bg-blue-900/30 border border-blue-500/30 rounded-xl p-4">
                            <div class="font-semibold">‚≠ê Cosmetic progression</div>
                            <div class="text-gray-400 text-[12px]">Award titles/badges (client-side now, server-side later) to increase identity + retention.</div>
                        </div>
                        <button class="bg-purple-700 hover:bg-purple-600 w-full py-3 rounded-xl font-semibold" onclick="showSection('store'); setStoreTab('vip');">Unlock VIP Rewards</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Tournaments Section -->
    <section id="tournaments" class="section hidden">
        <div class="max-w-6xl mx-auto">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold gold-gradient">üèÜ Tournaments</h2>
                <p class="text-gray-300">Compete for prize pools. Entry fees create sinks, leaderboards boost engagement, and VIP perks drive upgrades.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-black/30 border border-gray-700/50 rounded-2xl p-6 lg:col-span-2">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold gold-gradient">Live Events</h3>
                        <button class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-xs" onclick="renderTournaments()">Refresh</button>
                    </div>
                    <div class="mt-4" id="tournamentsList"></div>
                </div>

                <div class="bg-black/30 border border-gray-700/50 rounded-2xl p-6">
                    <h3 class="text-xl font-bold gold-gradient">Grow Faster</h3>
                    <div class="mt-3 space-y-3 text-sm text-gray-300">
                        <div class="bg-purple-900/40 border border-purple-500/30 rounded-xl p-4">
                            <div class="font-semibold">üîó Referral Link</div>
                            <div class="text-gray-400 text-[12px]">Invite friends. You earn rewards when they join (and later, when they purchase).</div>
                            <button class="btn-gold w-full mt-3 py-2 rounded-xl" onclick="shareReferral()">Copy Referral Link</button>
                            <div class="text-[11px] text-gray-500 mt-2">Tip: promote tournament weekends for the fastest viral lift.</div>
                        </div>

                        <div class="bg-emerald-900/30 border border-emerald-500/30 rounded-xl p-4">
                            <div class="font-semibold">üëë VIP Edge</div>
                            <div class="text-gray-400 text-[12px]">VIP gets ad-free mode + faster regen so they can enter more events.</div>
                            <button class="bg-purple-700 hover:bg-purple-600 w-full mt-3 py-2 rounded-xl font-semibold" onclick="showSection('store'); setStoreTab('vip');">Go VIP</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-gray-400 text-sm">
                <div class="bg-black/20 border border-gray-700/40 rounded-xl p-4">
                    <div class="font-semibold text-white">Server-side migration plan (Supabase)</div>
                    <div class="text-[12px] mt-1">Move tournament joins, scoring, and payouts into Supabase with RLS + an Edge Function for secure scoring and prize distribution.</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Slots Section -->
    <section id="slots" class="section hidden">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-4xl font-bold gold-gradient text-center mb-8">üé∞ Royal Slots</h2>

            <div class="slot-machine p-8 mx-auto max-w-lg">
                <div class="text-center mb-6">
                    <div class="text-sm text-gray-400">BET AMOUNT</div>
                    <div class="text-3xl font-bold text-[#d4af37]" id="slotBet">$10.00</div>
                </div>

                <div class="flex justify-center space-x-4 mb-6">
                    <div class="slot-reel w-24 h-32" id="reel1"><div class="slot-symbol" id="symbol1">üçí</div></div>
                    <div class="slot-reel w-24 h-32" id="reel2"><div class="slot-symbol" id="symbol2">üçí</div></div>
                    <div class="slot-reel w-24 h-32" id="reel3"><div class="slot-symbol" id="symbol3">üçí</div></div>
                </div>

                <div class="text-center mb-6">
                    <div class="text-sm text-gray-400">WIN</div>
                    <div class="text-3xl font-bold text-green-400" id="slotWin">$0.00</div>
                </div>

                <div class="flex justify-center space-x-4 mb-6">
                    <button class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg transition" onclick="changeSlotBet(-5)">-</button>
                const SUPABASE_URL ='https://ympmemzazjimghbefhvf.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltcG1lbXphemppbWdoYmVmaHZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMjIzMzUsImV4cCI6MjA4Mjc5ODMzNX0.EOUNNGxDiGPiip93WLWchZ8jtaii2tzb6qQjFJI2wHE
                    <button class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg transition" onclick="changeSlotBet(-1)">-</button>
                    <button class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg transition" onclick="changeSlotBet(1)">+</button>
                    <button class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg transition" onclick="changeSlotBet(5)">+</button>
                </div>

                <button class="btn-gold w-full py-4 rounded-xl text-2xl" id="spinBtn" onclick="spinSlots()">üé∞ SPIN</button>
                <button class="w-full py-3 rounded-xl text-xl mt-3 bg-yellow-600 hover:bg-yellow-700 transition" onclick="autoSpin()">‚ö° AUTO SPIN</button>
            </div>

            <div class="mt-8 bg-purple-900/50 rounded-xl p-6 border border-purple-500/30">
                <h3 class="text-xl font-bold gold-gradient mb-4 text-center">üíé Paytable</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üíéüíéüíé</div><div class="text-yellow-400 font-bold">50x</div></div>
                    <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£</div><div class="text-yellow-400 font-bold">25x</div></div>
                    <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üçÄüçÄüçÄ</div><div class="text-yellow-400 font-bold">15x</div></div>
                    <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üçíüçíüçí</div><div class="text-yellow-400 font-bold">10x</div></div>
                    <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üçãüçãüçã</div><div class="text-yellow-400 font-bold">8x</div></div>
                    <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üçäüçäüçä</div><div class="text-yellow-400 font-bold">5x</div></div>
                    <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üçáüçáüçá</div><div class="text-yellow-400 font-bold">4x</div></div>
                    <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">ANY PAIR</div><div class="text-yellow-400 font-bold">2x</div></div>
                </div>
                <div class="text-center mt-4 text-gray-400 text-sm">RTP: 96.5% | House Edge: 3.5%</div>
            </div>
        </div>
    </section>

    <!-- New Mexico Themed Slots Section -->
    <section id="nmSlots" class="section hidden">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-4xl font-bold text-center mb-2 gold-gradient">üèúÔ∏è New Mexico Roadrunner Reels</h2>
            <p class="text-center text-gray-300 mb-6">Spin through the high desert with Zia symbols, roadrunners, cacti, and sunsets over the Sandias.</p>

            <div class="slot-machine p-8 mx-auto max-w-lg" style="background: radial-gradient(circle at top, #facc15 0%, #7c2d12 45%, #1b1024 100%);">
                <!-- NM Flag Banner with more accurate Zia-style symbol -->
                <div class="flex items-center justify-center mb-4 space-x-3">
                    <div class="w-14 h-9 rounded border-2 border-amber-300 flex items-center justify-center relative overflow-hidden" style="background:#facc15;">
                        <!-- Center circle -->
                        <div class="absolute w-3.5 h-3.5 rounded-full border-[3px] border-red-700"></div>

                        <!-- Four groups of rays (each group has 4 rays) -->
                        <!-- North rays -->
                        <div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-2.5 h-3 bg-red-700 rounded"></div>
                        <div class="absolute top-2 left-1/2 -translate-x-1/2 w-2.5 h-2 bg-[#facc15]"></div>
                        <div class="absolute top-3.5 left-1/2 -translate-x-1/2 w-2.5 h-3 bg-red-700 rounded"></div>

                        <!-- South rays -->
                        <div class="absolute -bottom-0.5 left-1/2 -translate-x-1/2 w-2.5 h-3 bg-red-700 rounded"></div>
                        <div class="absolute bottom-2 left-1/2 -translate-x-1/2 w-2.5 h-2 bg-[#facc15]"></div>
                        <div class="absolute bottom-3.5 left-1/2 -translate-x-1/2 w-2.5 h-3 bg-red-700 rounded"></div>

                        <!-- West rays -->
                        <div class="absolute left-0.5 top-1/2 -translate-y-1/2 h-2.5 w-3 bg-red-700 rounded"></div>
                        <div class="absolute left-2 top-1/2 -translate-y-1/2 h-2.5 w-2 bg-[#facc15]"></div>
                        <div class="absolute left-3.5 top-1/2 -translate-y-1/2 h-2.5 w-3 bg-red-700 rounded"></div>

                        <!-- East rays -->
                        <div class="absolute right-0.5 top-1/2 -translate-y-1/2 h-2.5 w-3 bg-red-700 rounded"></div>
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 h-2.5 w-2 bg-[#facc15]"></div>
                        <div class="absolute right-3.5 top-1/2 -translate-y-1/2 h-2.5 w-3 bg-red-700 rounded"></div>
                    </div>
                    <span class="text-xs uppercase tracking-[0.2em] text-amber-200">New Mexico Bonus Game</span>
                </div>

                <div class="text-center mb-4">
                    <div class="text-sm text-amber-100">BET AMOUNT</div>
                    <div class="text-3xl font-bold text-amber-300" id="nmSlotBet">$5.00</div>
                </div>

                <div class="flex justify-center space-x-4 mb-4">
                    <div class="slot-reel w-24 h-32 bg-gradient-to-b from-orange-900 to-purple-900" id="nmReel1"><div class="slot-symbol" id="nmSymbol1">üèúÔ∏è</div></div>
                    <div class="slot-reel w-24 h-32 bg-gradient-to-b from-orange-900 to-purple-900" id="nmReel2"><div class="slot-symbol" id="nmSymbol2">üê¶</div></div>
                    <div class="slot-reel w-24 h-32 bg-gradient-to-b from-orange-900 to-purple-900" id="nmReel3"><div class="slot-symbol" id="nmSymbol3">üåµ</div></div>
                </div>

                <div class="flex items-center justify-between mb-4 text-xs text-amber-100">
                    <div class="flex items-center space-x-1"><span>üê¶</span><span>Roadrunner Rush</span></div>
                    <div class="flex items-center space-x-1"><span>‚òÄÔ∏è</span><span>Zia Super Bonus</span></div>
                    <div class="flex items-center space-x-1"><span>üåµ</span><span>Cactus Wilds</span></div>
                </div>

                <div class="text-center mb-4">
                    <div class="text-sm text-amber-100">WIN</div>
                    <div class="text-3xl font-bold text-emerald-300" id="nmSlotWin">$0.00</div>
                </div>

                <div class="flex justify-center space-x-4 mb-4">
                    <button class="bg-orange-700 hover:bg-orange-800 px-4 py-2 rounded-lg text-sm transition" onclick="changeNmSlotBet(-1)">-</button>
                    <button class="bg-orange-700 hover:bg-orange-800 px-4 py-2 rounded-lg text-sm transition" onclick="changeNmSlotBet(1)">+</button>
                </div>

                <button class="btn-gold w-full py-3 rounded-xl text-xl" id="nmSpinBtn" onclick="spinNmSlots()">üê¶ SPIN THE DESERT</button>

                <div class="mt-3 text-center text-[11px] text-amber-100/80">RTP: 96.5% ‚Ä¢ House Edge: 3.5% ‚Ä¢ Roadrunner Races and Zia Bonus rounds appear randomly for big multipliers.</div>
            </div>

            <div class="mt-8 bg-purple-900/60 rounded-xl p-6 border border-amber-400/40">
                <h3 class="text-xl font-bold gold-gradient mb-4 text-center">üèúÔ∏è New Mexico Paytable</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center text-sm">
                    <div class="bg-orange-900/60 rounded-lg p-3 border border-amber-400/30"><div class="text-2xl">‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è</div><div class="text-amber-300 font-bold">40x</div><div class="text-amber-100/70 text-[11px]">Triple Zia Suns</div></div>
                    <div class="bg-orange-900/60 rounded-lg p-3 border border-amber-400/30"><div class="text-2xl">üê¶üê¶üê¶</div><div class="text-amber-300 font-bold">20x</div><div class="text-amber-100/70 text-[11px]">Roadrunner Jackpots</div></div>
                    <div class="bg-orange-900/60 rounded-lg p-3 border border-amber-400/30"><div class="text-2xl">üåµüåµüåµ</div><div class="text-amber-300 font-bold">10x</div><div class="text-amber-100/70 text-[11px]">Cactus Wildways</div></div>
                    <div class="bg-orange-900/60 rounded-lg p-3 border border-amber-400/30"><div class="text-2xl">üèúÔ∏èüèúÔ∏èüèúÔ∏è</div><div class="text-amber-300 font-bold">8x</div><div class="text-amber-100/70 text-[11px]">Desert Panorama</div></div>
                    <div class="bg-orange-900/60 rounded-lg p-3 border border-amber-400/30"><div class="text-2xl">üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è</div><div class="text-amber-300 font-bold">6x</div><div class="text-amber-100/70 text-[11px]">Chile Pepper Heat</div></div>
                    <div class="bg-orange-900/60 rounded-lg p-3 border border-amber-400/30"><div class="text-2xl">üèïÔ∏èüèïÔ∏èüèïÔ∏è</div><div class="text-amber-300 font-bold">4x</div><div class="text-amber-100/70 text-[11px]">Campfire Nights</div></div>
                    <div class="bg-orange-900/60 rounded-lg p-3 border border-amber-400/30"><div class="text-2xl">ANY PAIR</div><div class="text-amber-300 font-bold">2x</div><div class="text-amber-100/70 text-[11px]">Any two matching symbols</div></div>
                    <div class="bg-orange-900/60 rounded-lg p-3 border border-amber-400/30"><div class="text-2xl">Roadrunner Rush</div><div class="text-amber-300 font-bold">Random 3‚Äì10x</div><div class="text-amber-100/70 text-[11px]">Triggered on surprise sprints</div></div>
                </div>
            </div>
        </div>
    </section>

    <!-- VIP Lounge (Exclusive) -->
    <section id="vipLounge" class="section hidden">
        <div class="max-w-6xl mx-auto">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold gold-gradient">üëë VIP Lounge</h2>
                <p class="text-gray-300">Exclusive games, higher limits, and VIP-only perks.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <div class="slot-machine p-8">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <div class="text-xs uppercase tracking-widest text-gray-400">Exclusive</div>
                            <div class="text-2xl font-bold gold-gradient">üíé Diamond Slots</div>
                            <div class="text-[12px] text-gray-400">Higher limits ‚Ä¢ VIP-only room</div>
                        </div>
                        <div class="px-3 py-1 rounded-full bg-[#d4af37]/20 border border-[#d4af37]/40 text-[#f4e4a6] text-xs font-semibold">VIP</div>
                    </div>

                    <div class="text-center mb-6">
                        <div class="text-sm text-gray-400">BET AMOUNT</div>
                        <div class="text-3xl font-bold text-[#d4af37]" id="vipSlotBet">$50.00</div>
                    </div>

                    <div class="flex justify-center space-x-4 mb-6">
                        <div class="slot-reel w-24 h-32" id="vipReel1"><div class="slot-symbol" id="vipSymbol1">üëë</div></div>
                        <div class="slot-reel w-24 h-32" id="vipReel2"><div class="slot-symbol" id="vipSymbol2">üíé</div></div>
                        <div class="slot-reel w-24 h-32" id="vipReel3"><div class="slot-symbol" id="vipSymbol3">7Ô∏è‚É£</div></div>
                    </div>

                    <div class="text-center mb-6">
                        <div class="text-sm text-gray-400">WIN</div>
                        <div class="text-3xl font-bold text-emerald-400" id="vipSlotWin">$0.00</div>
                    </div>

                    <div class="flex justify-center space-x-3 mb-5">
                        <button class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition" onclick="changeVipSlotBet(-25)">-</button>
                        <button class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition" onclick="changeVipSlotBet(-5)">-</button>
                        <button class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition" onclick="changeVipSlotBet(5)">+</button>
                        <button class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition" onclick="changeVipSlotBet(25)">+</button>
                    </div>

                    <button class="btn-gold w-full py-4 rounded-xl text-2xl" id="vipSpinBtn" onclick="spinVipSlots()">üíé SPIN VIP</button>

                    <div class="mt-4 text-center text-gray-400 text-sm">RTP: 96.5% | House Edge: 3.5%</div>
                </div>

                <div class="bg-black/30 border border-gray-700/50 rounded-2xl p-6">
                    <h3 class="text-2xl font-bold gold-gradient">VIP Benefits</h3>
                    <div class="mt-4 space-y-3 text-gray-300">
                        <div class="flex items-start gap-3"><span>üéÅ</span><div><div class="font-semibold">2x Daily Bonus</div><div class="text-sm text-gray-400">Boosts streak bonuses instantly.</div></div></div>
                        <div class="flex items-start gap-3"><span>‚ö°</span><div><div class="font-semibold">Faster Coin Regen</div><div class="text-sm text-gray-400">Higher rate and higher cap.</div></div></div>
                        <div class="flex items-start gap-3"><span>üö´</span><div><div class="font-semibold">Ad-free Mode</div><div class="text-sm text-gray-400">Removes rewarded placements in UI.</div></div></div>
                        <div class="flex items-start gap-3"><span>üéß</span><div><div class="font-semibold">Priority Support</div><div class="text-sm text-gray-400">VIP tickets get priority (demo).</div></div></div>
                    </div>

                    <div class="mt-6 p-4 rounded-xl bg-purple-900/40 border border-purple-500/30">
                        <div class="text-sm text-gray-300">Need VIP?</div>
                        <button class="btn-gold mt-3 w-full py-3 rounded-xl" onclick="showSection('store'); setStoreTab('vip');">Join VIP Club ($9.99/mo)</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Blackjack Section -->
    <section id="blackjack" class="section hidden">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-4xl font-bold gold-gradient text-center mb-8">üÉè Blackjack</h2>

            <div class="bg-green-900/50 rounded-2xl p-8 border border-green-500/30">
                <div class="text-center mb-8">
                    <div class="text-gray-400">Dealer's Hand <span id="dealerScore" class="text-white font-bold"></span></div>
                    <div class="flex justify-center space-x-4 mt-4" id="dealerCards"><div class="playing-card">?</div><div class="playing-card">?</div></div>
                </div>

                <div class="text-center my-8 py-4 border-t border-b border-green-500/30">
                    <div class="text-gray-400">Your Hand <span id="playerScore" class="text-white font-bold"></span></div>
                    <div class="flex justify-center space-x-4 mt-4" id="playerCards"></div>
                </div>

                <div class="text-center mb-8">
                    <div class="text-sm text-gray-400">BET</div>
                    <div class="text-3xl font-bold text-[#d4af37]" id="blackjackBet">$25.00</div>
                </div>

                <div class="flex flex-wrap justify-center gap-4 mb-6">
                    <div class="bet-chip chip-5" onclick="setBlackjackBet(5)">$5</div>
                    <div class="bet-chip chip-25" onclick="setBlackjackBet(25)">$25</div>
                    <div class="bet-chip chip-100" onclick="setBlackjackBet(100)">$100</div>
                    <div class="bet-chip chip-500" onclick="setBlackjackBet(500)">$500</div>
                </div>

                <div class="flex flex-wrap justify-center gap-4" id="blackjackActions">
                    <button class="btn-gold px-8 py-3 rounded-lg" onclick="dealBlackjack()">DEAL</button>
                    <button class="bg-green-600 hover:bg-green-700 px-8 py-3 rounded-lg transition hidden" id="hitBtn" onclick="hit()">HIT</button>
                    <button class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg transition hidden" id="standBtn" onclick="stand()">STAND</button>
                    <button class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-lg transition hidden" id="doubleBtn" onclick="doubleDown()">DOUBLE</button>
                </div>

                <div class="text-center mt-6 text-gray-400" id="blackjackMessage">Place your bet and click DEAL</div>
            </div>

            <div class="mt-6 text-center text-gray-400 text-sm">RTP: 99.5% | House Edge: 0.5% (with optimal play)</div>
        </div>
    </section>

    <!-- Roulette Section -->
    <section id="roulette" class="section hidden">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-4xl font-bold gold-gradient text-center mb-8">üéØ European Roulette</h2>

            <div class="flex flex-col lg:flex-row gap-8 items-center justify-center">
                <div class="flex flex-col items-center">
                    <div class="roulette-wheel" id="rouletteWheel"><div class="ball" id="rouletteBall"></div></div>
                    <div class="mt-6 text-center">
                        <div class="text-2xl font-bold" id="rouletteResult">Spin to Play!</div>
                        <div class="text-gray-400" id="rouletteWin"></div>
                    </div>
                </div>

                <div class="bg-green-900/80 rounded-xl p-6 border-4 border-[#d4af37]">
                    <div class="text-center mb-4">
                        <div class="text-sm text-gray-400">YOUR BET</div>
                        <div class="text-2xl font-bold text-[#d4af37]" id="rouletteBetAmount">$0.00</div>
                    </div>

                    <div class="flex justify-center mb-2"><div class="roulette-number green-num" onclick="placeRouletteBet(0, 'straight')">0</div></div>

                    <div class="grid grid-cols-12 gap-1 mb-2">
                        <div class="roulette-number red-num" onclick="placeRouletteBet(3, 'straight')">3</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(6, 'straight')">6</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(9, 'straight')">9</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(12, 'straight')">12</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(15, 'straight')">15</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(18, 'straight')">18</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(21, 'straight')">21</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(24, 'straight')">24</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(27, 'straight')">27</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(30, 'straight')">30</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(33, 'straight')">33</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(36, 'straight')">36</div>

                        <div class="roulette-number black-num" onclick="placeRouletteBet(2, 'straight')">2</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(5, 'straight')">5</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(8, 'straight')">8</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(11, 'straight')">11</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(14, 'straight')">14</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(17, 'straight')">17</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(20, 'straight')">20</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(23, 'straight')">23</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(26, 'straight')">26</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(29, 'straight')">29</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(32, 'straight')">32</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(35, 'straight')">35</div>

                        <div class="roulette-number red-num" onclick="placeRouletteBet(1, 'straight')">1</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(4, 'straight')">4</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(7, 'straight')">7</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(10, 'straight')">10</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(13, 'straight')">13</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(16, 'straight')">16</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(19, 'straight')">19</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(22, 'straight')">22</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(25, 'straight')">25</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(28, 'straight')">28</div>
                        <div class="roulette-number black-num" onclick="placeRouletteBet(31, 'straight')">31</div>
                        <div class="roulette-number red-num" onclick="placeRouletteBet(34, 'straight')">34</div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button class="bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm transition" onclick="placeRouletteBet('1st12', 'dozen')">1st 12</button>
                        <button class="bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm transition" onclick="placeRouletteBet('2nd12', 'dozen')">2nd 12</button>
                        <button class="bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm transition" onclick="placeRouletteBet('3rd12', 'dozen')">3rd 12</button>
                        <button class="bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm transition" onclick="placeRouletteBet('1-18', 'half')">1-18</button>
                        <button class="bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm transition" onclick="placeRouletteBet('even', 'color')">Even</button>
                        <button class="bg-red-600 hover:bg-red-700 py-2 rounded text-sm transition" onclick="placeRouletteBet('red', 'color')">Red</button>
                        <button class="bg-gray-900 hover:bg-black py-2 rounded text-sm transition" onclick="placeRouletteBet('black', 'color')">Black</button>
                        <button class="bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm transition" onclick="placeRouletteBet('odd', 'color')">Odd</button>
                        <button class="bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm transition" onclick="placeRouletteBet('19-36', 'half')">19-36</button>
                    </div>

                    <div class="flex flex-wrap justify-center gap-4 mt-4">
                        <div class="bet-chip chip-5" onclick="setRouletteChip(5)">$5</div>
                        <div class="bet-chip chip-10" onclick="setRouletteChip(10)">$10</div>
                        <div class="bet-chip chip-25" onclick="setRouletteChip(25)">$25</div>
                        <div class="bet-chip chip-100" onclick="setRouletteChip(100)">$100</div>
                    </div>

                    <div class="flex gap-4 mt-4">
                        <button id="rouletteSpinBtn" class="btn-gold flex-1 py-3 rounded-lg" onclick="spinRoulette()">SPIN</button>
                        <button class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg transition" onclick="clearRouletteBets()">CLEAR</button>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center text-gray-400 text-sm">RTP: 97.3% | House Edge: 2.7% (Single Zero)</div>
        </div>
    </section>

    <!-- Bingo Section -->
    <section id="bingo" class="section hidden">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-4xl font-bold gold-gradient text-center mb-8">üé± Bingo Hall</h2>

            <div class="flex flex-col lg:flex-row gap-8 items-start">
                <div class="flex-1">
                    <div class="bg-purple-900/50 rounded-xl p-6 border border-purple-500/30">
                        <div class="flex justify-center space-x-4 mb-6">
                            <div class="text-3xl font-bold text-red-400">B</div>
                            <div class="text-3xl font-bold text-yellow-400">I</div>
                            <div class="text-3xl font-bold text-green-400">N</div>
                            <div class="text-3xl font-bold text-blue-400">G</div>
                            <div class="text-3xl font-bold text-purple-400">O</div>
                        </div>

                        <div class="bingo-card" id="bingoCard"></div>

                        <div class="mt-6 text-center">
                            <div class="text-gray-400">Balls to Win: <span id="ballsToWin" class="text-[#d4af37] font-bold">5</span></div>
                            <div class="progress-bar mt-2"><div class="progress-fill" id="bingoProgress" style="width: 0%"></div></div>
                        </div>

                        <div class="mt-4 text-center text-[12px] text-gray-400" id="bingoBoostHint"></div>
                    </div>
                </div>

                <div class="flex-1">
                    <div class="bg-purple-900/50 rounded-xl p-6 border border-purple-500/30 text-center">
                        <div class="text-gray-400 mb-4">Current Call</div>
                        <div class="called-number" id="currentCall">-</div>

                        <div class="mt-8">
                            <div class="text-gray-400 mb-4">Called Numbers</div>
                            <div class="flex flex-wrap justify-center gap-2" id="calledNumbers"></div>
                        </div>

                        <div class="mt-8">
                            <div class="text-sm text-gray-400">CARD PRICE</div>
                            <div class="text-2xl font-bold text-[#d4af37]">$5.00</div>
                        </div>

                        <button class="btn-gold w-full py-4 rounded-xl text-xl mt-6" id="bingoPlayBtn" onclick="playBingo()">üé± PLAY BINGO</button>
                        <button class="bg-gray-600 hover:bg-gray-700 w-full py-3 rounded-xl mt-3 transition" onclick="newBingoCard()">üîÑ NEW CARD</button>
                    </div>

                    <div class="bg-purple-900/50 rounded-xl p-6 border border-purple-500/30 mt-6">
                        <h3 class="text-xl font-bold gold-gradient mb-4">üéâ Recent Winners</h3>
                        <div class="space-y-2 text-sm" id="bingoWinners">
                            <div class="flex justify-between"><span>BingoMaster</span><span class="text-green-400">$250</span></div>
                            <div class="flex justify-between"><span>LuckyLady88</span><span class="text-green-400">$180</span></div>
                            <div class="flex justify-between"><span>NumberKing</span><span class="text-green-400">$320</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center text-gray-400 text-sm">RTP: 85-90% | Varies by number of players</div>
        </div>
    </section>

    <!-- Video Poker Section -->
    <section id="poker" class="section hidden">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-4xl font-bold gold-gradient text-center mb-8">‚ô†Ô∏è Video Poker - Jacks or Better</h2>

            <div class="bg-gradient-to-b from-blue-900/80 to-blue-950/80 rounded-2xl p-8 border border-blue-500/30">
                <div class="flex justify-center space-x-4 mb-8" id="pokerCards">
                    <div class="playing-card cursor-pointer hover:scale-105 transition border-4 border-transparent" data-index="0" onclick="toggleHold(0)">?</div>
                    <div class="playing-card cursor-pointer hover:scale-105 transition border-4 border-transparent" data-index="1" onclick="toggleHold(1)">?</div>
                    <div class="playing-card cursor-pointer hover:scale-105 transition border-4 border-transparent" data-index="2" onclick="toggleHold(2)">?</div>
                    <div class="playing-card cursor-pointer hover:scale-105 transition border-4 border-transparent" data-index="3" onclick="toggleHold(3)">?</div>
                    <div class="playing-card cursor-pointer hover:scale-105 transition border-4 border-transparent" data-index="4" onclick="toggleHold(4)">?</div>
                </div>

                <div class="text-center mb-6"><div class="text-gray-400">Hand: <span id="pokerHand" class="text-[#d4af37] font-bold">Place bet to deal</span></div></div>

                <div class="text-center mb-6">
                    <div class="text-sm text-gray-400">BET</div>
                    <div class="text-3xl font-bold text-[#d4af37]" id="pokerBet">$5.00</div>
                </div>

                <div class="flex flex-wrap justify-center gap-4 mb-6">
                    <div class="bet-chip chip-5" onclick="setPokerBet(5)">$5</div>
                    <div class="bet-chip chip-25" onclick="setPokerBet(25)">$25</div>
                    <div class="bet-chip chip-100" onclick="setPokerBet(100)">$100</div>
                </div>

                <div class="flex justify-center gap-4">
                    <button class="btn-gold px-12 py-4 rounded-xl text-xl" id="pokerDealBtn" onclick="dealPoker()">DEAL</button>
                    <button class="bg-gray-600 hover:bg-gray-700 px-8 py-4 rounded-xl transition hidden" id="pokerDrawBtn" onclick="drawPoker()">DRAW</button>
                </div>
            </div>

            <div class="mt-6 bg-purple-900/50 rounded-xl p-6 border border-purple-500/30">
                <h3 class="text-xl font-bold gold-gradient mb-4 text-center">Paytable (per coin bet)</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center text-sm">
                    <div class="bg-purple-800/50 rounded-lg p-2">Royal Flush<br><span class="text-yellow-400 font-bold">250x</span></div>
                    <div class="bg-purple-800/50 rounded-lg p-2">Straight Flush<br><span class="text-yellow-400 font-bold">50x</span></div>
                    <div class="bg-purple-800/50 rounded-lg p-2">Four of a Kind<br><span class="text-yellow-400 font-bold">25x</span></div>
                    <div class="bg-purple-800/50 rounded-lg p-2">Full House<br><span class="text-yellow-400 font-bold">9x</span></div>
                    <div class="bg-purple-800/50 rounded-lg p-2">Flush<br><span class="text-yellow-400 font-bold">6x</span></div>
                    <div class="bg-purple-800/50 rounded-lg p-2">Straight<br><span class="text-yellow-400 font-bold">4x</span></div>
                    <div class="bg-purple-800/50 rounded-lg p-2">Three of a Kind<br><span class="text-yellow-400 font-bold">3x</span></div>
                    <div class="bg-purple-800/50 rounded-lg p-2">Two Pair<br><span class="text-yellow-400 font-bold">2x</span></div>
                    <div class="bg-purple-800/50 rounded-lg p-2">Jacks or Better<br><span class="text-yellow-400 font-bold">1x</span></div>
                </div>
                <div class="text-center mt-4 text-gray-400 text-sm">RTP: 99.54% | House Edge: 0.46% (9/6 Jacks or Better)</div>
            </div>
        </div>
    </section>

    <!-- Wheel of Fortune Section -->
    <section id="wheel" class="section hidden">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-4xl font-bold gold-gradient text-center mb-8">üéÅ Daily Wheel of Fortune</h2>

            <div class="bg-purple-900/50 rounded-2xl p-8 border border-purple-500/30">
                <div class="flex flex-col items-center">
                    <div class="relative mb-8">
                        <div class="wheel-pointer"></div>
                        <div class="wheel-of-fortune" id="fortuneWheel"></div>
                    </div>

                    <div class="text-center mb-6">
                        <div class="text-gray-400">Free spins available: <span id="freeSpins" class="text-[#d4af37] font-bold">3</span></div>
                        <div class="text-sm text-gray-500">Resets every 24 hours</div>
                    </div>

                    <button class="btn-gold px-12 py-4 rounded-xl text-2xl" id="spinWheelBtn" onclick="spinFortuneWheel()">üé∞ SPIN THE WHEEL!</button>
                    <div class="mt-8 text-center"><div class="text-4xl font-bold" id="wheelResult">Good Luck!</div></div>

                    <div class="mt-8 grid grid-cols-3 md:grid-cols-6 gap-4 text-center text-sm">
                        <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üéÅ</div><div>Coins</div></div>
                        <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üíé</div><div>Gems</div></div>
                        <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üé∞</div><div>Free Spins</div></div>
                        <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">2Ô∏è‚É£</div><div>2x Multi</div></div>
                        <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">5Ô∏è‚É£</div><div>5x Multi</div></div>
                        <div class="bg-purple-800/50 rounded-lg p-3"><div class="text-2xl">üÉè</div><div>Mystery</div></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

</main>

<!-- Checkout Modal -->
<div class="modal" id="checkoutModal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold gold-gradient" id="checkoutTitle">üí≥ Checkout</h3>
            <button class="text-gray-400 hover:text-white text-2xl" onclick="closeModal('checkout')">&times;</button>
        </div>

        <div class="space-y-4">
            <div class="bg-black/30 border border-gray-700/50 rounded-xl p-4">
                <div class="text-gray-400 text-sm">You are purchasing</div>
                <div class="text-xl font-bold" id="checkoutItemName">‚Äî</div>
                <div class="mt-1 text-gray-400 text-sm" id="checkoutItemDesc">‚Äî</div>
                <div class="mt-3 flex items-center justify-between">
                    <div class="text-gray-400">Total</div>
                    <div class="text-2xl font-bold text-emerald-300" id="checkoutPrice">$0.00</div>
                </div>
            </div>

            <div>
                <label class="block text-gray-400 mb-2">Card Number</label>
                <input type="text" id="cardNumber" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3" placeholder="4242 4242 4242 4242" maxlength="19">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-400 mb-2">Expiry</label>
                    <input type="text" id="cardExpiry" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3" placeholder="MM/YY" maxlength="5">
                </div>
                <div>
                    <label class="block text-gray-400 mb-2">CVC</label>
                    <input type="text" id="cardCvc" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3" placeholder="123" maxlength="3">
                </div>
            </div>

            <div id="checkoutBonusBox" class="bg-green-900/30 rounded-lg p-4 mt-2 hidden">
                <div class="flex items-center space-x-2 text-green-400">
                    <span>üéÅ</span>
                    <span id="checkoutBonusText">Bonus applied!</span>
                </div>
            </div>

            <button class="btn-gold w-full py-4 rounded-xl text-xl mt-2" onclick="processCheckout()">Pay Now</button>

            <p class="text-center text-gray-500 text-xs mt-2">üîí Stripe-ready checkout. On GitHub Pages you must use a backend (or Supabase Edge Function) for PaymentIntents/Checkout + webhooks. Demo mode simulates payment until wired.</p>
        </div>
    </div>
</div>

<!-- Support Modal -->
<div class="modal" id="supportModal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold gold-gradient">üéß Support</h3>
            <button class="text-gray-400 hover:text-white text-2xl" onclick="closeModal('support')">&times;</button>
        </div>

        <div class="space-y-4">
            <div class="bg-black/30 border border-gray-700/50 rounded-xl p-4">
                <div class="text-gray-400 text-sm">Support Tier</div>
                <div class="text-xl font-bold" id="supportTier">Standard</div>
                <div class="text-gray-400 text-sm" id="supportEta">Typical response: 6‚Äì24h</div>
            </div>

            <div>
                <label class="block text-gray-400 mb-2">Message</label>
                <textarea id="supportMessage" rows="5" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3" placeholder="Describe your issue..."></textarea>
            </div>

            <button class="btn-gold w-full py-4 rounded-xl text-xl" onclick="submitSupportTicket()">Submit Ticket</button>

            <div class="text-[12px] text-gray-500">
                VIP Club members are tagged <strong>Priority</strong>.
            </div>
        </div>
    </div>
</div>

<!-- Win Modal -->
<div class="modal" id="winModal">
    <div class="modal-content text-center">
        <div class="text-6xl mb-4">üéâ</div>
        <h3 class="text-3xl font-bold gold-gradient mb-4">BIG WIN!</h3>
        <div class="text-5xl font-bold text-green-400 mb-6" id="winAmount">$0.00</div>
        <button class="btn-gold px-12 py-4 rounded-xl text-xl" onclick="closeModal('win')">Continue Playing</button>
    </div>
</div>

<script>
    // ==================== SUPABASE (GitHub Pages compatible) ====================
    // Replace these two values with your project settings:
    // Supabase Dashboard ‚Üí Project Settings ‚Üí API
    // ==================== SUPABASE CONFIG (GitHub Pages friendly) ====================
    // 1) Supabase Dashboard ‚Üí Project Settings ‚Üí API
    // 2) Paste values below (anon key is public by design; protect data with RLS)
    const SUPABASE_URL = 'PASTE_YOUR_SUPABASE_URL_HERE';
    const SUPABASE_ANON_KEY = 'PASTE_YOUR_SUPABASE_ANON_KEY_HERE';

    // Optional: enable/disable remote persistence quickly
    const USE_SUPABASE = (
        typeof SUPABASE_URL === 'string' &&
        typeof SUPABASE_ANON_KEY === 'string' &&
        SUPABASE_URL.length > 10 &&
        SUPABASE_ANON_KEY.length > 10 &&
        !SUPABASE_URL.includes('PASTE_')
    );

    let supabaseClient = null;
    if (USE_SUPABASE && window.supabase?.createClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
        });
    }

    // ==================== GAME STATE ====================
    let gameState = {
        balance: 1000.00,
        slotBet: 10,
        blackjackBet: 25,
        rouletteChip: 10,
        rouletteBets: [],
        pokerBet: 5,
        freeSpins: 3,
        dailyStreak: 1,
        lastLogin: new Date().toDateString(),
        vipLevel: 0,
        vipXP: 0,
        totalWagered: 0,
        currentUser: null, // { username, email }
        lastClaim: null,

        // VIP Club subscription
        vipClub: {
            active: false,
            expiresAt: 0,
            startedAt: 0,
            adFree: false
        },

        // Coin regen
        lastRegenAt: Date.now(),

        // Purchases
        purchases: {
            bingoAutoDauberUntil: 0
        },

        // Checkout context
        checkout: {
            type: null, // 'pack' | 'vip' | 'item'
            id: null
        },

        nmSlotBet: 5,
        vipSlotBet: 50,

        // Supabase session/user
        session: null,
        userProfile: null,

        // Referral attribution (captured before signup)
        pendingRef: null
    };

    const savedState = localStorage.getItem('casinoState');
    if (savedState) {
        try {
            gameState = { ...gameState, ...JSON.parse(savedState) };
            // Deep merge nested objects
            gameState.vipClub = { ...{ active:false, expiresAt:0, startedAt:0, adFree:false }, ...(gameState.vipClub || {}) };
            gameState.purchases = { ...{ bingoAutoDauberUntil:0 }, ...(gameState.purchases || {}) };
            gameState.checkout = { ...{ type:null, id:null }, ...(gameState.checkout || {}) };
        } catch (e) {
            console.warn('Failed to parse saved state; using defaults.');
        }
    }

    // ==================== STORE CONFIG ====================
    const coinPacks = {
        starter: { name: 'Starter Pack', price: 2.99, coins: 10000, bonusCoins: 0, desc: 'Perfect for new players.' },
        daily: { name: 'Daily Booster', price: 7.99, coins: 25000, bonusCoins: 5000, desc: 'Limited-time daily refresh pack.' },
        royal: { name: 'Royal Bundle', price: 19.99, coins: 60000, bonusCoins: 10000, desc: 'Best value bundle with bonus coins.' },
        mega: { name: 'Mega Bundle', price: 29.99, coins: 150000, bonusCoins: 50000, desc: 'Big bonus pack for grinders.' },
        whale: { name: 'Whale Chest', price: 49.99, coins: 200000, bonusCoins: 60000, desc: 'High roller pack for serious play.' }
    };

    const items = {
        vipxp: { name: 'VIP Boost Token', price: 4.99, desc: '+1,000 VIP XP (progression only).', apply: () => { gameState.vipXP += 1000; updateVipUI(); } },
        autodauber: { name: 'Bingo Auto-Dauber', price: 2.99, desc: 'Auto-marks called numbers for 24 hours.', apply: () => { gameState.purchases.bingoAutoDauberUntil = Date.now() + 24*60*60*1000; } }
    };

    // ==================== UTILITY ====================
    function saveState() { localStorage.setItem('casinoState', JSON.stringify(gameState)); }

    // Debounced remote sync to Supabase
    let syncTimer = null;
    function scheduleProfileSync() {
        if (!supabaseClient || !gameState.session?.user) return;
        clearTimeout(syncTimer);
        syncTimer = setTimeout(() => { syncProfileToSupabase().catch(console.warn); }, 800);
    }

    async function syncProfileToSupabase() {
        if (!supabaseClient || !gameState.session?.user) return;
        const uid = gameState.session.user.id;

        const payload = {
            id: uid,
            username: gameState.currentUser?.username || null,
            email: gameState.currentUser?.email || gameState.session.user.email || null,
            coins: Math.floor(gameState.balance),
            vip_level: gameState.vipLevel || 0,
            vip_xp: Math.floor(gameState.vipXP || 0),
            total_wagered: Math.floor(gameState.totalWagered || 0),
            vip_active: !!isVipClubActive(),
            vip_expires_at: gameState.vipClub?.expiresAt ? new Date(gameState.vipClub.expiresAt).toISOString() : null,
            ad_free: !!(gameState.vipClub?.adFree),
            last_claim: gameState.lastClaim || null,
            daily_streak: gameState.dailyStreak || 1,
            free_spins: gameState.freeSpins || 0,
            updated_at: new Date().toISOString()
        };

        // Upsert into a "profiles" table (recommended). If you used "users" instead, rename it below.
        const { error } = await supabaseClient
            .from('profiles')
            .upsert(payload, { onConflict: 'id' });

        if (error) {
            console.warn('Supabase profile sync failed:', error.message);
        }
    }

    function updateBalance(amount) {
        gameState.balance = Number(gameState.balance || 0) + Number(amount || 0);
        if (gameState.balance < 0) gameState.balance = 0;
        const balEl = document.getElementById('balance');
        if (balEl) balEl.textContent = gameState.balance.toFixed(2);
        saveState();
        scheduleProfileSync();
    }

    function addWager(amount) {
        gameState.totalWagered += amount;
        gameState.vipXP += amount;
        updateVipUI();
        saveState();
        scheduleProfileSync();
    }

    function formatDateTime(ts) {
        try {
            const d = new Date(ts);
            return d.toLocaleString(undefined, { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
        } catch { return '‚Äî'; }
    }

    function isVipClubActive() {
        return !!(gameState.vipClub?.active && Date.now() < (gameState.vipClub.expiresAt || 0));
    }

    function ensureVipClubValidity() {
        if (gameState.vipClub?.active && Date.now() >= gameState.vipClub.expiresAt) {
            gameState.vipClub.active = false;
            // Keep adFree preference but will be disabled by UI
            saveState();
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    function createConfetti() {
        const colors = ['#d4af37', '#10b981', '#ef4444', '#3b82f6', '#8b5cf6'];
        for (let i = 0; i < 100; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }, i * 20);
        }
    }

    function showWinModal(amount) {
        document.getElementById('winAmount').textContent = '$' + amount.toFixed(2);
        openModal('win');
        createConfetti();
    }

    // ==================== VIP UI ====================
    function updateVipUI() {
        const level = Math.min(10, Math.floor(gameState.vipXP / 1000));
        gameState.vipLevel = level;
        const intoLevel = gameState.vipXP % 1000;
        const progress = Math.min(100, (intoLevel / 1000) * 100);
        const tiers = ['Bronze', 'Silver', 'Gold', 'Platinum', 'Diamond', 'Master', 'Legend', 'Mythic', 'Eternal', 'Omega', 'Infinity'];
        document.getElementById('vipLabel').textContent = `VIP ${level} ‚Ä¢ ${tiers[level] || 'Infinity'}`;
        document.getElementById('vipProgressBar').style.width = progress + '%';
        const authTotal = document.getElementById('authTotalWagered');
        if (authTotal) authTotal.textContent = '$' + gameState.totalWagered.toFixed(2);
        saveState();
    }

    function refreshVipClubUI() {
        ensureVipClubValidity();

        const active = isVipClubActive();

        // Top badge
        const badge = document.getElementById('vipClubBadge');
        badge.classList.toggle('hidden', !active);

        // Store VIP panel
        const pill = document.getElementById('vipClubStatusPill');
        const statusText = document.getElementById('vipClubStatusText');
        const expiry = document.getElementById('vipClubExpiry');
        const joinBtn = document.getElementById('vipJoinBtn');
        const cancelBtn = document.getElementById('vipCancelBtn');

        if (active) {
            pill.textContent = 'Active';
            pill.className = 'px-3 py-1 rounded-full text-xs border border-emerald-500/40 bg-emerald-600/20 text-emerald-200';
            statusText.textContent = 'Active';
            expiry.textContent = 'Renews/Expires: ' + formatDateTime(gameState.vipClub.expiresAt);
            joinBtn.textContent = 'VIP Active';
            joinBtn.disabled = true;
            joinBtn.classList.add('opacity-60', 'cursor-not-allowed');
            cancelBtn.classList.remove('hidden');
        } else {
            pill.textContent = 'Inactive';
            pill.className = 'px-3 py-1 rounded-full text-xs border border-gray-600 bg-black/30 text-gray-300';
            statusText.textContent = 'Inactive';
            expiry.textContent = '‚Äî';
            joinBtn.textContent = 'Join VIP Club';
            joinBtn.disabled = false;
            joinBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            cancelBtn.classList.add('hidden');
        }

        // Account panel status
        const authVip = document.getElementById('authVipClubStatus');
        if (authVip) authVip.textContent = active ? 'Active' : 'Inactive';

        // VIP daily hint
        document.getElementById('vipDailyBonusHint').classList.toggle('hidden', !active);

        // Ad-free toggle
        const t = document.getElementById('adFreeToggle');
        const canToggle = active;
        if (!canToggle) {
            t.classList.remove('on');
            gameState.vipClub.adFree = false;
        } else {
            t.classList.toggle('on', !!gameState.vipClub.adFree);
        }

        updateAdVisibility();
        updateDailyBonusUI();
        updateSupportUI();
        updateBingoBoostUI();
        saveState();
    }

    function toggleAdFree() {
        if (!isVipClubActive()) {
            showNotification('Ad-free is included with VIP Club.', 'info');
            return;
        }
        gameState.vipClub.adFree = !gameState.vipClub.adFree;
        refreshVipClubUI();
        showNotification(gameState.vipClub.adFree ? 'Ad-free enabled.' : 'Ad-free disabled.', 'success');
    }

    function updateAdVisibility() {
        const active = isVipClubActive();
        const adFree = active && !!gameState.vipClub.adFree;
        const banner = document.getElementById('adBanner');
        banner.classList.toggle('hidden', adFree);
    }

    // ==================== AUTH ====================
    function updateAuthUI() {
        const label = document.getElementById('currentUserLabel');
        const btn = document.getElementById('loginToggleBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        const username = gameState.currentUser?.username || (gameState.session?.user?.email ? gameState.session.user.email.split('@')[0] : null);

        if (username) {
            if (label) label.textContent = username;
            if (btn) btn.textContent = 'Account';
            if (logoutBtn) logoutBtn.classList.remove('hidden');
        } else {
            if (label) label.textContent = 'Guest';
            if (btn) btn.textContent = 'Sign in';
            if (logoutBtn) logoutBtn.classList.add('hidden');
        }
    }

    function toggleAuthPanel() {
        document.getElementById('authPanel').classList.toggle('hidden');
    }

    async function loginOrRegister() {
        const username = document.getElementById('authUsername').value.trim();
        const email = document.getElementById('authEmail').value.trim();
        const password = document.getElementById('authPassword').value;

        if (!username) { showNotification('Please enter a username', 'error'); return; }
        if (!email) { showNotification('Please enter an email', 'error'); return; }
        if (!password || password.length < 6) { showNotification('Password must be at least 6 characters', 'error'); return; }

        // Always store locally for instant UX
        gameState.currentUser = { username, email };
        saveState();
        updateAuthUI();

        if (!supabaseClient) {
            refreshVipClubUI();
            toggleAuthPanel();
            showNotification(`Welcome, ${username}! (Local mode)`, 'success');
            return;
        }

        try {
            // Try sign-in first
            let { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            // If sign-in fails, attempt sign-up
            if (error) {
                const signUp = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: { data: { username } }
                });
                data = signUp.data;
                error = signUp.error;
            }

            if (error) throw error;

            const session = data.session;
            if (session) {
                gameState.session = session;
                await ensureProfileExists(session.user.id, username, email);
                await loadProfileFromSupabase(session.user.id);
                await applyReferralIfEligible();
            } else {
                showNotification('Check your email to confirm your account (if confirmations are enabled).', 'info');
            }

            toggleAuthPanel();
            showNotification(`Signed in as ${username}`, 'success');
        } catch (err) {
            console.error(err);
            showNotification(err?.message || 'Auth failed', 'error');
        }
    }

    async function sendMagicLink() {
        const email = document.getElementById('authEmail').value.trim();
        if (!supabaseClient) { showNotification('Supabase is not configured.', 'error'); return; }
        if (!email) { showNotification('Enter email first.', 'error'); return; }

        // IMPORTANT for GitHub Pages:
        // In Supabase Dashboard ‚Üí Auth ‚Üí URL Configuration:
        // set Site URL to your GitHub Pages URL.
        const { error } = await supabaseClient.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: window.location.href }
        });
        if (error) showNotification(error.message, 'error');
        else showNotification('Magic link sent. Check your email.', 'success');
    }

    async function forgotPassword() {
        const email = document.getElementById('authEmail').value.trim();
        if (!supabaseClient) { showNotification('Supabase is not configured.', 'error'); return; }
        if (!email) { showNotification('Enter email first.', 'error'); return; }

        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href
        });
        if (error) showNotification(error.message, 'error');
        else showNotification('Password reset email sent.', 'success');
    }

    async function logout() {
        if (supabaseClient) {
            await supabaseClient.auth.signOut();
        }
        gameState.session = null;
        gameState.userProfile = null;
        gameState.currentUser = null;
        saveState();
        updateAuthUI();
        refreshVipClubUI();
        showNotification('Logged out.', 'info');
    }

    // ==================== NAVIGATION / MODALS ====================
    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        const el = document.getElementById(sectionId);
        if (el) el.classList.remove('hidden');
        window.scrollTo(0, 0);
    }

    function openModal(type) {
        const id = type + 'Modal';
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
    }

    function closeModal(type) {
        const id = type + 'Modal';
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
    }

    function openVipLounge() {
        if (!isVipClubActive()) {
            showNotification('VIP Lounge is for VIP Club members. Join to unlock.', 'info');
            showSection('store');
            setStoreTab('vip');
            return;
        }
        showSection('vipLounge');
    }

    // ==================== STORE TABS ====================
    function setStoreTab(tab) {
        const coins = document.getElementById('storeCoins');
        const vip = document.getElementById('storeVip');
        const specials = document.getElementById('storeSpecials');

        coins.classList.toggle('hidden', tab !== 'coins');
        vip.classList.toggle('hidden', tab !== 'vip');
        specials.classList.toggle('hidden', tab !== 'specials');

        document.getElementById('tabCoins').classList.toggle('active', tab === 'coins');
        document.getElementById('tabVip').classList.toggle('active', tab === 'vip');
        document.getElementById('tabSpecials').classList.toggle('active', tab === 'specials');

        refreshVipClubUI();
    }

    function quickBuy() {
        showSection('store');
        setStoreTab('coins');
        // Scroll to top of store
        window.scrollTo(0, 0);
    }

    // ==================== CHECKOUT FLOW (Stripe-ready; demo simulated) ====================
    // ==================== STRIPE (client) ====================
    // Paste your Stripe publishable key below. For production, use pk_live_...
    let stripe = null;
    const STRIPE_PUBLISHABLE_KEY = 'pk_test_PASTE_YOUR_STRIPE_PUBLISHABLE_KEY_HERE';
    try {
        if (typeof Stripe === 'function' && STRIPE_PUBLISHABLE_KEY && !STRIPE_PUBLISHABLE_KEY.includes('PASTE_')) {
            stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        }
    } catch (e) {
        console.warn('Stripe not initialized. Add your publishable key to enable real payments.');
    }

    // GitHub Pages note:
    // - Real Stripe payments require a backend (or Supabase Edge Function) to create PaymentIntents/Checkout Sessions.
    // - This UI keeps a demo fallback when Stripe/backend is not wired.

    function startCheckout(type, id) {
        gameState.checkout = { type, id };

        const title = document.getElementById('checkoutTitle');
        const nameEl = document.getElementById('checkoutItemName');
        const descEl = document.getElementById('checkoutItemDesc');
        const priceEl = document.getElementById('checkoutPrice');
        const bonusBox = document.getElementById('checkoutBonusBox');
        const bonusText = document.getElementById('checkoutBonusText');

        bonusBox.classList.add('hidden');

        if (type === 'pack') {
            const pack = coinPacks[id];
            nameEl.textContent = pack?.name || 'Coin Pack';
            descEl.textContent = `${pack.coins.toLocaleString()} coins${pack.bonusCoins ? ` + ${pack.bonusCoins.toLocaleString()} bonus` : ''}`;
            priceEl.textContent = '$' + (pack?.price ?? 0).toFixed(2);
            title.textContent = 'üí≥ Buy Coins';
            if (pack?.bonusCoins) {
                bonusBox.classList.remove('hidden');
                bonusText.textContent = `Includes bonus: +${pack.bonusCoins.toLocaleString()} coins`;
            }
        } else if (type === 'vip') {
            nameEl.textContent = 'VIP Club Subscription';
            descEl.textContent = 'Monthly plan: 2x daily bonus, ad-free, VIP Lounge, faster regen, priority support.';
            priceEl.textContent = '$9.99';
            title.textContent = 'üëë Join VIP Club';
            bonusBox.classList.remove('hidden');
            bonusText.textContent = 'VIP Welcome Gift: +5,000 coins';
        } else if (type === 'item') {
            const it = items[id];
            nameEl.textContent = it?.name || 'Item';
            descEl.textContent = it?.desc || '';
            priceEl.textContent = '$' + (it?.price ?? 0).toFixed(2);
            title.textContent = 'üßæ Purchase';
        }

        saveState();
        openModal('checkout');
    }

    async function processCheckout() {
        const cn = document.getElementById('cardNumber').value.trim();
        const ex = document.getElementById('cardExpiry').value.trim();
        const cv = document.getElementById('cardCvc').value.trim();

        if (!cn || !ex || !cv) {
            showNotification('Please fill all card details', 'error');
            return;
        }

        // Production wiring (recommended):
        // 1) Create a Supabase Edge Function (or any backend) that creates a Stripe Checkout Session or PaymentIntent.
        // 2) Call it from here with: type/id/user_id
        // 3) Redirect to Stripe Checkout OR confirmCardPayment.
        // 4) Use Stripe webhook to credit coins / activate VIP server-side.

        // GitHub Pages: without a backend/edge function, we keep demo-mode simulation.
        const backendReady = false; // set true once you wire an Edge Function endpoint

        showNotification('Processing payment...', 'info');

        if (backendReady && stripe) {
            // Example (Stripe Checkout) pseudo-flow:
            // const { data } = await supabaseClient.functions.invoke('create-checkout', { body: { type, id } });
            // await stripe.redirectToCheckout({ sessionId: data.sessionId });
            showNotification('Stripe backend not wired yet. Falling back to demo mode.', 'info');
        }

        setTimeout(() => {
            const { type, id } = gameState.checkout || {};

            if (type === 'pack') {
                const pack = coinPacks[id];
                if (!pack) {
                    showNotification('Invalid pack.', 'error');
                    return;
                }
                updateBalance(pack.coins + (pack.bonusCoins || 0));
                showNotification(`Purchase successful: +${(pack.coins + (pack.bonusCoins || 0)).toLocaleString()} coins!`, 'success');
                createConfetti();
            }

            if (type === 'vip') {
                activateVipClub();
            }

            if (type === 'item') {
                const it = items[id];
                if (!it) {
                    showNotification('Invalid item.', 'error');
                    return;
                }
                it.apply();
                showNotification(`Purchased: ${it.name}`, 'success');
            }

            gameState.checkout = { type:null, id:null };
            saveState();
            refreshVipClubUI();
            closeModal('checkout');
        }, 1200);
    }

    function activateVipClub() {
        const now = Date.now();
        gameState.vipClub.active = true;
        gameState.vipClub.startedAt = now;
        gameState.vipClub.expiresAt = now + 30 * 24 * 60 * 60 * 1000;
        gameState.vipClub.adFree = true; // enable by default

        // VIP welcome gift
        updateBalance(5000);

        // Achievement hook
        updateAchievementProgress('vip', 1);

        showNotification('VIP Club activated! +5,000 coins welcome gift.', 'success');
        createConfetti();
        refreshVipClubUI();
        saveState();
    }

    function cancelVipClub() {
        gameState.vipClub.active = false;
        // keep expiresAt for audit; UI will treat inactive
        showNotification('VIP Club cancelled. You will lose benefits after expiry in a real system.', 'info');
        refreshVipClubUI();
        saveState();
    }

    // ==================== VIP FEATURES ====================
    function updateDailyBonusUI() {
        const streak = gameState.dailyStreak || 1;
        const multiplier = isVipClubActive() ? 2 : 1;
        const amount = 500 * streak * multiplier;
        document.getElementById('dailyBonusAmount').textContent = amount.toLocaleString();
    }

    function updateSupportUI() {
        const tier = document.getElementById('supportTier');
        const eta = document.getElementById('supportEta');
        if (isVipClubActive()) {
            tier.textContent = 'VIP Priority';
            eta.textContent = 'Typical response: 5‚Äì60 min';
        } else {
            tier.textContent = 'Standard';
            eta.textContent = 'Typical response: 6‚Äì24h';
        }
    }

    function submitSupportTicket() {
        const msg = document.getElementById('supportMessage').value.trim();
        if (!msg) {
            showNotification('Please enter a message.', 'error');
            return;
        }
        const tag = isVipClubActive() ? 'PRIORITY' : 'STANDARD';
        document.getElementById('supportMessage').value = '';
        closeModal('support');
        showNotification(`Ticket submitted (${tag}).`, 'success');
    }

    function updateBingoBoostUI() {
        const hint = document.getElementById('bingoBoostHint');
        const active = Date.now() < (gameState.purchases.bingoAutoDauberUntil || 0);
        if (active) {
            hint.textContent = 'Auto-Dauber active: called numbers will auto-mark.';
        } else {
            hint.textContent = '';
        }
    }

    // ==================== COIN REGEN ====================
    function coinRegenTick() {
        ensureVipClubValidity();

        const now = Date.now();
        const last = gameState.lastRegenAt || now;
        const elapsedMs = Math.max(0, now - last);

        // Regen config
        const vip = isVipClubActive();
        const cap = vip ? 5000 : 2000;
        const perMinute = vip ? 90 : 30; // coins per minute

        const coinsPerMs = perMinute / 60000;
        const toAdd = Math.floor(elapsedMs * coinsPerMs);

        if (toAdd > 0) {
            if (gameState.balance < cap) {
                const add = Math.min(toAdd, Math.floor(cap - gameState.balance));
                if (add > 0) updateBalance(add);
            }
            gameState.lastRegenAt = now;
            saveState();
        }

        const regenHint = document.getElementById('regenHint');
        const adFree = vip && gameState.vipClub.adFree;
        regenHint.textContent = `Regen: ${perMinute}/min ‚Ä¢ Cap: ${cap}${adFree ? ' ‚Ä¢ Ad-free' : ''}`;
    }

    // ==================== DAILY BONUS ====================
    function claimDailyBonus() {
        const today = new Date().toDateString();

        if (gameState.lastClaim === today) {
            showNotification('Already claimed today! Come back tomorrow.', 'info');
            return;
        }

        // Streak
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        gameState.dailyStreak = (gameState.lastClaim === yesterday)
            ? Math.min(7, (gameState.dailyStreak || 1) + 1)
            : 1;

        const multiplier = isVipClubActive() ? 2 : 1;
        const bonus = 500 * gameState.dailyStreak * multiplier;

        updateBalance(bonus);
        gameState.lastClaim = today;

        showNotification(`Day ${gameState.dailyStreak} bonus: +${bonus.toLocaleString()} coins${multiplier > 1 ? ' (VIP 2x)' : ''}!`, 'success');
        createConfetti();
        updateDailyBonusUI();
        saveState();
    }

    // ==================== REWARDED AD (SIMULATED) ====================
    function watchAdForCoins() {
        if (isVipClubActive() && gameState.vipClub.adFree) {
            showNotification('VIP Club is ad-free. No need to watch ads!', 'info');
            return;
        }
        showNotification('Playing ad...', 'info');
        setTimeout(() => {
            updateBalance(500);
            showNotification('Ad reward: +500 coins!', 'success');
        }, 1200);
    }

    // ==================== SLOTS GAME ====================
    const slotSymbols = ['üçí', 'üçã', 'üçä', 'üçá', 'üçÄ', '7Ô∏è‚É£', 'üíé'];
    const slotWeights = [0.25, 0.20, 0.18, 0.15, 0.12, 0.07, 0.03];

    function getWeightedSymbol() {
        const rand = Math.random();
        let cumulative = 0;
        for (let i = 0; i < slotSymbols.length; i++) {
            cumulative += slotWeights[i];
            if (rand <= cumulative) return slotSymbols[i];
        }
        return slotSymbols[0];
    }

    const nmSlotSymbols = ['‚òÄÔ∏è', 'üê¶', 'üåµ', 'üèúÔ∏è', 'üå∂Ô∏è', 'üèïÔ∏è'];
    const nmSlotWeights = [0.10, 0.18, 0.20, 0.20, 0.18, 0.14];

    function getWeightedNmSymbol() {
        const rand = Math.random();
        let cumulative = 0;
        for (let i = 0; i < nmSlotSymbols.length; i++) {
            cumulative += nmSlotWeights[i];
            if (rand <= cumulative) return nmSlotSymbols[i];
        }
        return nmSlotSymbols[0];
    }

    const vipSlotSymbols = ['üëë', 'üíé', '7Ô∏è‚É£', 'üçÄ', 'üî•', '‚≠ê'];
    const vipSlotWeights = [0.10, 0.06, 0.10, 0.20, 0.24, 0.30];

    function getWeightedVipSymbol() {
        const rand = Math.random();
        let cumulative = 0;
        for (let i = 0; i < vipSlotSymbols.length; i++) {
            cumulative += vipSlotWeights[i];
            if (rand <= cumulative) return vipSlotSymbols[i];
        }
        return vipSlotSymbols[vipSlotSymbols.length - 1];
    }

    function changeSlotBet(amount) {
        gameState.slotBet = Math.max(1, Math.min(500, gameState.slotBet + amount));
        document.getElementById('slotBet').textContent = '$' + gameState.slotBet.toFixed(2);
        saveState();
    }

    function changeNmSlotBet(delta) {
        gameState.nmSlotBet = Math.max(1, Math.min(250, (gameState.nmSlotBet || 5) + delta));
        document.getElementById('nmSlotBet').textContent = '$' + gameState.nmSlotBet.toFixed(2);
        saveState();
    }

    function changeVipSlotBet(delta) {
        if (!isVipClubActive()) {
            showNotification('VIP Lounge requires VIP Club.', 'info');
            showSection('store');
            setStoreTab('vip');
            return;
        }
        gameState.vipSlotBet = Math.max(10, Math.min(5000, (gameState.vipSlotBet || 50) + delta));
        document.getElementById('vipSlotBet').textContent = '$' + gameState.vipSlotBet.toFixed(2);
        saveState();
    }

    let autoSpinning = false;

    async function spinSlots() {
        if (gameState.balance < gameState.slotBet) {
            showNotification('Insufficient balance! Visit the Store to buy coins.', 'error');
            return;
        }

        updateBalance(-gameState.slotBet);
        addWager(gameState.slotBet);

        const spinBtn = document.getElementById('spinBtn');
        spinBtn.disabled = true;

        for (let i = 1; i <= 3; i++) document.getElementById('reel' + i).classList.add('spinning');

        const results = [getWeightedSymbol(), getWeightedSymbol(), getWeightedSymbol()];

        for (let i = 1; i <= 3; i++) {
            await new Promise(resolve => setTimeout(resolve, 500));
            document.getElementById('reel' + i).classList.remove('spinning');
            document.getElementById('symbol' + i).textContent = results[i-1];
        }

        let winMultiplier = 0;
        if (results[0] === results[1] && results[1] === results[2]) {
            switch(results[0]) {
                case 'üíé': winMultiplier = 50; break;
                case '7Ô∏è‚É£': winMultiplier = 25; break;
                case 'üçÄ': winMultiplier = 15; break;
                case 'üçí': winMultiplier = 10; break;
                case 'üçã': winMultiplier = 8; break;
                case 'üçä': winMultiplier = 5; break;
                case 'üçá': winMultiplier = 4; break;
            }
        } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
            winMultiplier = 2;
        }

        const win = gameState.slotBet * winMultiplier;
        if (win > 0) {
            updateBalance(win);
            const winEl = document.getElementById('slotWin');
            winEl.textContent = '$' + win.toFixed(2);
            winEl.classList.add('win-animation');

            if (win >= gameState.slotBet * 10) showWinModal(win);
            else showNotification('You won $' + win.toFixed(2) + '!', 'success');

            setTimeout(() => winEl.classList.remove('win-animation'), 2000);
        } else {
            document.getElementById('slotWin').textContent = '$0.00';
        }

        spinBtn.disabled = false;
        saveState();

        if (autoSpinning) setTimeout(spinSlots, 1000);
    }

    function autoSpin() {
        autoSpinning = !autoSpinning;
        if (autoSpinning) spinSlots();
    }

    async function spinNmSlots() {
        if (gameState.balance < (gameState.nmSlotBet || 5)) {
            showNotification('Insufficient balance for New Mexico slots!', 'error');
            return;
        }

        updateBalance(-(gameState.nmSlotBet || 5));
        addWager(gameState.nmSlotBet || 5);

        const spinBtn = document.getElementById('nmSpinBtn');
        spinBtn.disabled = true;

        for (let i = 1; i <= 3; i++) document.getElementById('nmReel' + i).classList.add('spinning');

        const results = [getWeightedNmSymbol(), getWeightedNmSymbol(), getWeightedNmSymbol()];

        for (let i = 1; i <= 3; i++) {
            await new Promise(resolve => setTimeout(resolve, 450));
            document.getElementById('nmReel' + i).classList.remove('spinning');
            document.getElementById('nmSymbol' + i).textContent = results[i - 1];
        }

        let winMultiplier = 0;
        if (results[0] === results[1] && results[1] === results[2]) {
            switch (results[0]) {
                case '‚òÄÔ∏è': winMultiplier = 40; break;
                case 'üê¶': winMultiplier = 20; break;
                case 'üåµ': winMultiplier = 10; break;
                case 'üèúÔ∏è': winMultiplier = 8; break;
                case 'üå∂Ô∏è': winMultiplier = 6; break;
                case 'üèïÔ∏è': winMultiplier = 4; break;
            }
        } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
            winMultiplier = 2;
        }

        const hasRoadrunner = results.includes('üê¶');
        if (hasRoadrunner && Math.random() < 0.15) {
            const bonusMulti = 1 + Math.floor(Math.random() * 8);
            winMultiplier = Math.max(2, winMultiplier) * bonusMulti;
            showNotification('Roadrunner Rush! Multiplier boosted!', 'success');
        }

        const bet = gameState.nmSlotBet || 5;
        const win = bet * winMultiplier;

        if (win > 0) {
            updateBalance(win);
            const winEl = document.getElementById('nmSlotWin');
            winEl.textContent = '$' + win.toFixed(2);
            winEl.classList.add('win-animation');

            if (win >= bet * 10) showWinModal(win);
            else showNotification('You won $' + win.toFixed(2) + ' on New Mexico Reels!', 'success');

            setTimeout(() => winEl.classList.remove('win-animation'), 2000);
        } else {
            document.getElementById('nmSlotWin').textContent = '$0.00';
        }

        spinBtn.disabled = false;
        saveState();
    }

    async function spinVipSlots() {
        if (!isVipClubActive()) {
            showNotification('VIP Lounge requires VIP Club.', 'info');
            showSection('store');
            setStoreTab('vip');
            return;
        }

        const bet = gameState.vipSlotBet || 50;
        if (gameState.balance < bet) {
            showNotification('Insufficient balance! Buy more coins in the Store.', 'error');
            return;
        }

        updateBalance(-bet);
        addWager(bet);

        const spinBtn = document.getElementById('vipSpinBtn');
        spinBtn.disabled = true;

        for (let i = 1; i <= 3; i++) document.getElementById('vipReel' + i).classList.add('spinning');

        const results = [getWeightedVipSymbol(), getWeightedVipSymbol(), getWeightedVipSymbol()];

        for (let i = 1; i <= 3; i++) {
            await new Promise(resolve => setTimeout(resolve, 520));
            document.getElementById('vipReel' + i).classList.remove('spinning');
            document.getElementById('vipSymbol' + i).textContent = results[i - 1];
        }

        let winMultiplier = 0;
        if (results[0] === results[1] && results[1] === results[2]) {
            switch(results[0]) {
                case 'üíé': winMultiplier = 60; break;
                case 'üëë': winMultiplier = 40; break;
                case '7Ô∏è‚É£': winMultiplier = 25; break;
                case 'üî•': winMultiplier = 15; break;
                case 'üçÄ': winMultiplier = 10; break;
                case '‚≠ê': winMultiplier = 6; break;
            }
        } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
            winMultiplier = 2;
        }

        const win = bet * winMultiplier;
        if (win > 0) {
            updateBalance(win);
            const winEl = document.getElementById('vipSlotWin');
            winEl.textContent = '$' + win.toFixed(2);
            winEl.classList.add('win-animation');

            if (win >= bet * 10) showWinModal(win);
            else showNotification('VIP win: $' + win.toFixed(2), 'success');

            setTimeout(() => winEl.classList.remove('win-animation'), 2000);
        } else {
            document.getElementById('vipSlotWin').textContent = '$0.00';
        }

        spinBtn.disabled = false;
        saveState();
    }

    // ==================== BLACKJACK ====================
    let blackjackDeck = [];
    let playerHand = [];
    let dealerHand = [];
    let blackjackGameActive = false;

    function createDeck() {
        const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
        const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        const deck = [];
        for (let suit of suits) for (let value of values) deck.push({ suit, value });
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
        return deck;
    }

    function getCardValue(card) {
        if (['J','Q','K'].includes(card.value)) return 10;
        if (card.value === 'A') return 11;
        return parseInt(card.value);
    }

    function calculateHand(hand) {
        let total = 0;
        let aces = 0;
        for (let card of hand) {
            total += getCardValue(card);
            if (card.value === 'A') aces++;
        }
        while (total > 21 && aces > 0) { total -= 10; aces--; }
        return total;
    }

    function displayCard(card, hidden = false) {
        const isRed = card.suit === 'hearts' || card.suit === 'diamonds';
        const suitSymbol = { hearts:'‚ô•', diamonds:'‚ô¶', clubs:'‚ô£', spades:'‚ô†' }[card.suit];
        if (hidden) return `<div class="playing-card bg-gradient-to-br from-red-600 to-red-800">üÇ†</div>`;
        return `<div class="playing-card ${isRed ? 'red' : 'black'}">${card.value}${suitSymbol}</div>`;
    }

    function setBlackjackBet(amount) {
        if (blackjackGameActive) return;
        gameState.blackjackBet = amount;
        document.getElementById('blackjackBet').textContent = '$' + amount.toFixed(2);
        saveState();
    }

    function dealBlackjack() {
        if (gameState.balance < gameState.blackjackBet) { showNotification('Insufficient balance!', 'error'); return; }

        updateBalance(-gameState.blackjackBet);
        addWager(gameState.blackjackBet);

        blackjackDeck = createDeck();
        playerHand = [blackjackDeck.pop(), blackjackDeck.pop()];
        dealerHand = [blackjackDeck.pop(), blackjackDeck.pop()];
        blackjackGameActive = true;

        document.getElementById('playerCards').innerHTML = playerHand.map(c => displayCard(c)).join('');
        document.getElementById('dealerCards').innerHTML = displayCard(dealerHand[0]) + displayCard(dealerHand[1], true);
        document.getElementById('playerScore').textContent = calculateHand(playerHand);
        document.getElementById('dealerScore').textContent = getCardValue(dealerHand[0]);

        document.getElementById('hitBtn').classList.remove('hidden');
        document.getElementById('standBtn').classList.remove('hidden');
        document.getElementById('doubleBtn').classList.remove('hidden');

        if (calculateHand(playerHand) === 21) stand();

        document.getElementById('blackjackMessage').textContent = 'Hit or Stand?';
        saveState();
    }

    function hit() {
        playerHand.push(blackjackDeck.pop());
        document.getElementById('playerCards').innerHTML = playerHand.map(c => displayCard(c)).join('');
        document.getElementById('playerScore').textContent = calculateHand(playerHand);
        document.getElementById('doubleBtn').classList.add('hidden');
        if (calculateHand(playerHand) > 21) endBlackjack('bust');
    }

    function stand() {
        while (calculateHand(dealerHand) < 17) dealerHand.push(blackjackDeck.pop());

        document.getElementById('dealerCards').innerHTML = dealerHand.map(c => displayCard(c)).join('');
        document.getElementById('dealerScore').textContent = calculateHand(dealerHand);

        const playerTotal = calculateHand(playerHand);
        const dealerTotal = calculateHand(dealerHand);

        if (dealerTotal > 21) endBlackjack('dealerBust');
        else if (playerTotal > dealerTotal) endBlackjack('win');
        else if (playerTotal < dealerTotal) endBlackjack('lose');
        else endBlackjack('push');
    }

    function doubleDown() {
        if (gameState.balance < gameState.blackjackBet) { showNotification('Insufficient balance to double!', 'error'); return; }

        updateBalance(-gameState.blackjackBet);
        addWager(gameState.blackjackBet);

        gameState.blackjackBet *= 2;
        document.getElementById('blackjackBet').textContent = '$' + gameState.blackjackBet.toFixed(2);

        playerHand.push(blackjackDeck.pop());
        document.getElementById('playerCards').innerHTML = playerHand.map(c => displayCard(c)).join('');
        document.getElementById('playerScore').textContent = calculateHand(playerHand);

        if (calculateHand(playerHand) > 21) endBlackjack('bust');
        else stand();
    }

    function endBlackjack(result) {
        blackjackGameActive = false;
        document.getElementById('hitBtn').classList.add('hidden');
        document.getElementById('standBtn').classList.add('hidden');
        document.getElementById('doubleBtn').classList.add('hidden');

        let message = '';
        let winAmount = 0;
        switch(result) {
            case 'bust': message = 'Bust! You lose.'; break;
            case 'dealerBust': message = 'Dealer busts! You win!'; winAmount = gameState.blackjackBet * 2; break;
            case 'win': message = 'You win!'; winAmount = gameState.blackjackBet * 2; break;
            case 'lose': message = 'Dealer wins.'; break;
            case 'push': message = 'Push - Bet returned.'; winAmount = gameState.blackjackBet; break;
        }

        if (winAmount > 0) { updateBalance(winAmount); showNotification(message + ' +$' + winAmount.toFixed(2), 'success'); }
        else showNotification(message, 'info');

        document.getElementById('blackjackMessage').textContent = message;
        gameState.blackjackBet = 25;
        document.getElementById('blackjackBet').textContent = '$25.00';
        saveState();
    }

    // ==================== ROULETTE ====================
    const rouletteNumbers = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
    const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];

    function setRouletteChip(amount) { gameState.rouletteChip = amount; saveState(); }

    function placeRouletteBet(number, type) {
        if (gameState.balance < gameState.rouletteChip) { showNotification('Insufficient balance!', 'error'); return; }
        gameState.rouletteBets.push({ number, type, amount: gameState.rouletteChip });
        updateBalance(-gameState.rouletteChip);
        addWager(gameState.rouletteChip);
        const total = gameState.rouletteBets.reduce((sum, bet) => sum + bet.amount, 0);
        document.getElementById('rouletteBetAmount').textContent = '$' + total.toFixed(2);
        saveState();
    }

    function clearRouletteBets() {
        const total = gameState.rouletteBets.reduce((sum, bet) => sum + bet.amount, 0);
        updateBalance(total);
        gameState.rouletteBets = [];
        document.getElementById('rouletteBetAmount').textContent = '$0.00';
        saveState();
    }

    function spinRoulette() {
        if (gameState.rouletteBets.length === 0) { showNotification('Place your bets first!', 'info'); return; }

        const wheel = document.getElementById('rouletteWheel');
        const ball = document.getElementById('rouletteBall');
        const spinBtn = document.getElementById('rouletteSpinBtn');
        spinBtn.disabled = true;

        const resultIndex = Math.floor(Math.random() * rouletteNumbers.length);
        const result = rouletteNumbers[resultIndex];
        const isRed = redNumbers.includes(result);

        const rotation = 360 * 5 + (resultIndex * (360 / 37));
        wheel.style.transition = 'transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
        wheel.style.transform = `rotate(${rotation}deg)`;
        ball.style.transition = 'all 5s cubic-bezier(0.17, 0.67, 0.12, 0.99)';

        setTimeout(() => {
            document.getElementById('rouletteResult').textContent = result + (result === 0 ? ' (Green)' : (isRed ? ' (Red)' : ' (Black)'));

            let totalWin = 0;
            for (let bet of gameState.rouletteBets) {
                let win = 0;
                switch(bet.type) {
                    case 'straight': if (bet.number === result) win = bet.amount * 36; break;
                    case 'color':
                        if ((bet.number === 'red' && isRed) || (bet.number === 'black' && !isRed && result !== 0)) win = bet.amount * 2;
                        break;
                    case 'dozen':
                        if (bet.number === '1st12' && result >= 1 && result <= 12) win = bet.amount * 3;
                        if (bet.number === '2nd12' && result >= 13 && result <= 24) win = bet.amount * 3;
                        if (bet.number === '3rd12' && result >= 25 && result <= 36) win = bet.amount * 3;
                        break;
                    case 'half':
                        if (bet.number === '1-18' && result >= 1 && result <= 18) win = bet.amount * 2;
                        if (bet.number === '19-36' && result >= 19 && result <= 36) win = bet.amount * 2;
                        break;
                }
                totalWin += win;
            }

            if (totalWin > 0) {
                updateBalance(totalWin);
                document.getElementById('rouletteWin').textContent = 'You won $' + totalWin.toFixed(2) + '!';
                document.getElementById('rouletteWin').classList.add('text-green-400');
                showNotification('You won $' + totalWin.toFixed(2) + '!', 'success');
                if (totalWin >= 500) createConfetti();
            } else {
                document.getElementById('rouletteWin').textContent = 'No win this time';
                document.getElementById('rouletteWin').classList.remove('text-green-400');
            }

            gameState.rouletteBets = [];
            document.getElementById('rouletteBetAmount').textContent = '$0.00';
            spinBtn.disabled = false;

            setTimeout(() => {
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
            }, 2000);

            saveState();
        }, 5000);
    }

    // ==================== BINGO ====================
    let bingoCard = [];
    let calledNumbers = [];
    let bingoGameActive = false;

    function generateBingoCard() {
        const card = [];
        const columns = [
            { min: 1, max: 15 },
            { min: 16, max: 30 },
            { min: 31, max: 45 },
            { min: 46, max: 60 },
            { min: 61, max: 75 }
        ];

        for (let col = 0; col < 5; col++) {
            const numbers = [];
            while (numbers.length < 5) {
                const num = Math.floor(Math.random() * (columns[col].max - columns[col].min + 1)) + columns[col].min;
                if (!numbers.includes(num)) numbers.push(num);
            }
            for (let row = 0; row < 5; row++) {
                if (row === 2 && col === 2) card[row * 5 + col] = { number: 'FREE', marked: true };
                else card[row * 5 + col] = { number: numbers[row], marked: false };
            }
        }
        return card;
    }

    function renderBingoCard() {
        const container = document.getElementById('bingoCard');
        container.innerHTML = '';

        bingoCard.forEach((cell, index) => {
            const div = document.createElement('div');
            div.className = 'bingo-cell' + (cell.marked ? ' marked' : '');
            div.textContent = cell.number === 'FREE' ? '‚≠ê' : cell.number;
            div.onclick = () => markBingoCell(index);
            container.appendChild(div);
        });
    }

    function markBingoCell(index) {
        if (!bingoGameActive) return;
        if (bingoCard[index].number === 'FREE') return;
        if (!calledNumbers.includes(bingoCard[index].number)) return;
        bingoCard[index].marked = true;
        renderBingoCard();
        checkBingoWin();
    }

    function autoDaubNumber(num) {
        const active = Date.now() < (gameState.purchases.bingoAutoDauberUntil || 0);
        if (!active) return;
        bingoCard.forEach((cell, idx) => {
            if (cell.number === num && !cell.marked) {
                cell.marked = true;
            }
        });
        renderBingoCard();
        checkBingoWin();
    }

    function checkBingoWin() {
        const wins = [
            [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
            [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
            [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
        ];

        for (let win of wins) {
            if (win.every(index => bingoCard[index].marked)) {
                bingoGameActive = false;

                const ballsCalled = calledNumbers.length;
                const prizeMultiplier = Math.max(1, 50 - ballsCalled);
                const prize = 5 * prizeMultiplier;

                updateBalance(prize);
                showWinModal(prize);
                document.getElementById('bingoPlayBtn').disabled = false;

                win.forEach(index => {
                    document.querySelectorAll('.bingo-cell')[index].classList.add('bingo-winner');
                });

                return true;
            }
        }
        return false;
    }

    function updateBingoProgress() {
        const markedCount = bingoCard.filter(c => c.marked).length; // includes FREE
        const needed = 5;
        const progress = Math.min(100, (markedCount / needed) * 100);
        document.getElementById('bingoProgress').style.width = progress + '%';
        document.getElementById('ballsToWin').textContent = Math.max(0, needed - markedCount);
    }

    function newBingoCard() {
        bingoCard = generateBingoCard();
        calledNumbers = [];
        bingoGameActive = false;

        renderBingoCard();
        document.getElementById('calledNumbers').innerHTML = '';
        document.getElementById('currentCall').textContent = '-';
        document.getElementById('bingoProgress').style.width = '0%';
        document.getElementById('ballsToWin').textContent = '5';
        document.getElementById('bingoPlayBtn').disabled = false;
        updateBingoBoostUI();
        saveState();
    }

    function playBingo() {
        if (gameState.balance < 5) { showNotification('Insufficient balance!', 'error'); return; }

        updateBalance(-5);
        addWager(5);

        bingoGameActive = true;
        document.getElementById('bingoPlayBtn').disabled = true;

        let callCount = 0;
        const maxCalls = 75;

        const callInterval = setInterval(() => {
            if (!bingoGameActive) { clearInterval(callInterval); return; }

            if (callCount >= maxCalls) {
                clearInterval(callInterval);
                showNotification('Game over - No bingo', 'info');
                bingoGameActive = false;
                document.getElementById('bingoPlayBtn').disabled = false;
                return;
            }

            let num;
            do { num = Math.floor(Math.random() * 75) + 1; } while (calledNumbers.includes(num));

            calledNumbers.push(num);

            const callEl = document.getElementById('currentCall');
            callEl.textContent = num;
            callEl.classList.remove('called-number');
            void callEl.offsetWidth;
            callEl.classList.add('called-number');

            const numDiv = document.createElement('div');
            numDiv.className = 'w-10 h-10 rounded-full bg-purple-700 flex items-center justify-center text-sm';
            numDiv.textContent = num;
            document.getElementById('calledNumbers').appendChild(numDiv);

            // Highlight if on card
            bingoCard.forEach((cell, index) => {
                if (cell.number === num && !cell.marked) {
                    const cellEl = document.querySelectorAll('.bingo-cell')[index];
                    if (cellEl) cellEl.style.borderColor = '#10b981';
                }
            });

            // Auto daub if purchased
            autoDaubNumber(num);

            updateBingoProgress();
            callCount++;
        }, 1600);

        gameState.bingoInterval = callInterval;
        saveState();
    }

    // ==================== VIDEO POKER ====================
    let pokerDeck = [];
    let pokerHand = [];
    let pokerHeld = [false, false, false, false, false];
    let pokerDrawPhase = false;

    const pokerPaytable = {
        'Royal Flush': 250,
        'Straight Flush': 50,
        'Four of a Kind': 25,
        'Full House': 9,
        'Flush': 6,
        'Straight': 4,
        'Three of a Kind': 3,
        'Two Pair': 2,
        'Jacks or Better': 1
    };

    function setPokerBet(amount) {
        if (pokerDrawPhase) return;
        gameState.pokerBet = amount;
        document.getElementById('pokerBet').textContent = '$' + amount.toFixed(2);
        saveState();
    }

    function toggleHold(index) {
        if (!pokerDrawPhase) return;
        pokerHeld[index] = !pokerHeld[index];
        const cards = document.querySelectorAll('#pokerCards .playing-card');
        cards[index].style.borderColor = pokerHeld[index] ? '#d4af37' : 'transparent';
    }

    function evaluatePokerHand(hand) {
        const values = hand.map(c => {
            if (c.value === 'A') return 14;
            if (c.value === 'K') return 13;
            if (c.value === 'Q') return 12;
            if (c.value === 'J') return 11;
            return parseInt(c.value);
        }).sort((a, b) => a - b);

        const suits = hand.map(c => c.suit);
        const isFlush = suits.every(s => s === suits[0]);
        const isStraight = values.every((v, i) => i === 0 || v === values[i-1] + 1) || (values.join(',') === '2,3,4,5,14');

        const valueCounts = {};
        values.forEach(v => valueCounts[v] = (valueCounts[v] || 0) + 1);
        const counts = Object.values(valueCounts).sort((a, b) => b - a);

        if (isFlush && isStraight && values[4] === 14) return 'Royal Flush';
        if (isFlush && isStraight) return 'Straight Flush';
        if (counts[0] === 4) return 'Four of a Kind';
        if (counts[0] === 3 && counts[1] === 2) return 'Full House';
        if (isFlush) return 'Flush';
        if (isStraight) return 'Straight';
        if (counts[0] === 3) return 'Three of a Kind';
        if (counts[0] === 2 && counts[1] === 2) return 'Two Pair';

        if (counts[0] === 2) {
            const pairValue = Object.keys(valueCounts).find(v => valueCounts[v] === 2);
            if (pairValue && parseInt(pairValue) >= 11) return 'Jacks or Better';
        }

        return 'Nothing';
    }

    function dealPoker() {
        if (gameState.balance < gameState.pokerBet) { showNotification('Insufficient balance!', 'error'); return; }

        updateBalance(-gameState.pokerBet);
        addWager(gameState.pokerBet);

        pokerDeck = createDeck();
        pokerHand = [];
        pokerHeld = [false, false, false, false, false];
        pokerDrawPhase = true;

        for (let i = 0; i < 5; i++) pokerHand.push(pokerDeck.pop());

        const cards = document.querySelectorAll('#pokerCards .playing-card');
        pokerHand.forEach((card, i) => {
            const isRed = card.suit === 'hearts' || card.suit === 'diamonds';
            const suitSymbol = { hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£', spades: '‚ô†' }[card.suit];
            cards[i].className = 'playing-card ' + (isRed ? 'red' : 'black') + ' cursor-pointer hover:scale-105 transition border-4 border-transparent';
            cards[i].innerHTML = `${card.value}${suitSymbol}`;
        });

        document.getElementById('pokerHand').textContent = 'Select cards to hold, then DRAW';
        document.getElementById('pokerDealBtn').classList.add('hidden');
        document.getElementById('pokerDrawBtn').classList.remove('hidden');
        saveState();
    }

    function drawPoker() {
        for (let i = 0; i < 5; i++) if (!pokerHeld[i]) pokerHand[i] = pokerDeck.pop();

        const cards = document.querySelectorAll('#pokerCards .playing-card');
        pokerHand.forEach((card, i) => {
            const isRed = card.suit === 'hearts' || card.suit === 'diamonds';
            const suitSymbol = { hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£', spades: '‚ô†' }[card.suit];
            cards[i].className = 'playing-card ' + (isRed ? 'red' : 'black') + ' cursor-pointer hover:scale-105 transition border-4 border-transparent';
            cards[i].innerHTML = `${card.value}${suitSymbol}`;
        });

        const handResult = evaluatePokerHand(pokerHand);
        const multiplier = pokerPaytable[handResult] || 0;
        const win = gameState.pokerBet * multiplier;

        document.getElementById('pokerHand').textContent = handResult;

        if (win > 0) {
            updateBalance(win);
            showNotification(`${handResult}! You won $${win.toFixed(2)}!`, 'success');
            if (win >= gameState.pokerBet * 10) createConfetti();
        }

        pokerDrawPhase = false;
        document.getElementById('pokerDealBtn').classList.remove('hidden');
        document.getElementById('pokerDrawBtn').classList.add('hidden');
        saveState();
    }

    // ==================== WHEEL OF FORTUNE ====================
    const wheelPrizes = [
        { name: '100', type: 'coins', value: 100, color: '#10b981' },
        { name: '50', type: 'coins', value: 50, color: '#3b82f6' },
        { name: '2x', type: 'multiplier', value: 2, color: '#8b5cf6' },
        { name: '20', type: 'coins', value: 20, color: '#f59e0b' },
        { name: '10', type: 'freespins', value: 10, color: '#ef4444' },
        { name: '500', type: 'coins', value: 500, color: '#10b981' },
        { name: '5', type: 'coins', value: 5, color: '#6b7280' },
        { name: '5x', type: 'multiplier', value: 5, color: '#8b5cf6' },
        { name: '200', type: 'coins', value: 200, color: '#10b981' },
        { name: '3', type: 'freespins', value: 3, color: '#ef4444' },
        { name: '25', type: 'coins', value: 25, color: '#f59e0b' },
        { name: 'MYSTERY', type: 'mystery', value: 0, color: '#d4af37' }
    ];

    function createFortuneWheel() {
        const wheel = document.getElementById('fortuneWheel');
        wheel.innerHTML = '';
        const segmentAngle = 360 / wheelPrizes.length;

        wheelPrizes.forEach((prize, i) => {
            const segment = document.createElement('div');
            segment.className = 'wheel-segment';
            segment.style.cssText = `
                transform: rotate(${i * segmentAngle}deg) skewY(${90 - segmentAngle}deg);
                background: ${prize.color};
                width: 50%;
                height: 50%;
                transform-origin: 0% 100%;
            `;

            const label = document.createElement('span');
            label.style.cssText = `
                transform: skewY(${-(90 - segmentAngle)}deg) rotate(${segmentAngle / 2}deg) translateY(-100px);
                font-size: 14px;
            `;
            label.textContent = prize.name;
            segment.appendChild(label);
            wheel.appendChild(segment);
        });
    }

    function spinFortuneWheel() {
        if (gameState.freeSpins <= 0) { showNotification('No free spins available!', 'error'); return; }

        gameState.freeSpins--;
        document.getElementById('freeSpins').textContent = gameState.freeSpins;

        const wheel = document.getElementById('fortuneWheel');
        const spinBtn = document.getElementById('spinWheelBtn');
        spinBtn.disabled = true;

        const prizeIndex = Math.floor(Math.random() * wheelPrizes.length);
        const segmentAngle = 360 / wheelPrizes.length;
        const targetAngle = 360 * 5 + (prizeIndex * segmentAngle) + segmentAngle / 2;

        wheel.style.transition = 'transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
        wheel.style.transform = `rotate(-${targetAngle}deg)`;

        setTimeout(() => {
            const prize = wheelPrizes[prizeIndex];
            let message = '';
            let winAmount = 0;

            switch(prize.type) {
                case 'coins':
                    winAmount = prize.value;
                    updateBalance(winAmount);
                    message = `You won ${prize.value} coins!`;
                    break;
                case 'freespins':
                    gameState.freeSpins += prize.value;
                    document.getElementById('freeSpins').textContent = gameState.freeSpins;
                    message = `You won ${prize.value} free spins!`;
                    break;
                case 'multiplier':
                    winAmount = gameState.slotBet * prize.value;
                    updateBalance(winAmount);
                    message = `${prize.value}x Multiplier! +${winAmount} coins!`;
                    break;
                case 'mystery':
                    const mysteryPrizes = [50, 100, 200, 500, 1000];
                    const mysteryWin = mysteryPrizes[Math.floor(Math.random() * mysteryPrizes.length)];
                    winAmount = mysteryWin;
                    updateBalance(mysteryWin);
                    message = `MYSTERY! You won ${mysteryWin} coins!`;
                    break;
            }

            document.getElementById('wheelResult').textContent = message;
            showNotification(message, 'success');
            if (winAmount >= 100) createConfetti();

            spinBtn.disabled = false;

            setTimeout(() => {
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
            }, 2000);

            saveState();
        }, 5000);
    }

    // ==================== JACKPOT ANIMATION ====================
    function updateJackpot() {
        const jackpotEl = document.getElementById('jackpot');
        const current = parseFloat(jackpotEl.textContent.replace(/[$,]/g, ''));
        const newAmount = current + Math.random() * 0.5;
        jackpotEl.textContent = '$' + newAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    setInterval(updateJackpot, 3000);

    // ==================== DOWNLOAD / PWA HELPERS ====================
    let deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('PWA install prompt captured');
    });

    async function downloadApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const choiceResult = await deferredPrompt.userChoice;
            if (choiceResult.outcome === 'accepted') showNotification('App install started. Check your home screen!', 'success');
            else showNotification('Install dismissed. You can try again anytime.', 'info');
            deferredPrompt = null;
            return;
        }

        try {
            const html = document.documentElement.outerHTML;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'royal-fortune-casino.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Download started: royal-fortune-casino.html', 'success');
        } catch (err) {
            console.error(err);
            showNotification('Unable to download right now. Please try again.', 'error');
        }
    }

    // ==================== ACHIEVEMENTS ====================
    function getAchievements() {
        if (!gameState.achievements) {
            gameState.achievements = [
                { id: 'first_spin', name: 'First Spin', desc: 'Spin any slot 1 time.', type: 'slots', target: 1, progress: 0, reward: 100, claimed: false },
                { id: 'slots_100', name: 'Slot Grinder', desc: 'Spin slots 100 times.', type: 'slots', target: 100, progress: 0, reward: 1000, claimed: false },
                { id: 'wager_10k', name: 'High Stakes', desc: 'Wager a total of $10,000.', type: 'wager', target: 10000, progress: 0, reward: 2500, claimed: false },
                { id: 'win_5k', name: 'Big Winner', desc: 'Win a total of 5,000 coins.', type: 'win', target: 5000, progress: 0, reward: 1500, claimed: false },
                { id: 'vip_join', name: 'VIP Member', desc: 'Activate VIP Club.', type: 'vip', target: 1, progress: 0, reward: 2000, claimed: false }
            ];
        }
        return gameState.achievements;
    }

    function updateAchievementProgress(type, amount) {
        const achievements = getAchievements();
        achievements.forEach(a => {
            if (a.claimed) return;
            if (a.type !== type) return;
            a.progress = Math.min(a.target, (a.progress || 0) + amount);
        });
        saveState();
        renderAchievements();
    }

    function claimAchievement(id) {
        const achievements = getAchievements();
        const a = achievements.find(x => x.id === id);
        if (!a || a.claimed || (a.progress || 0) < a.target) {
            showNotification('Achievement not ready to claim.', 'error');
            return;
        }
        a.claimed = true;
        updateBalance(a.reward);
        showNotification(`Achievement unlocked! +${a.reward.toLocaleString()} coins`, 'success');
        createConfetti();
        saveState();
        renderAchievements();
    }

    function renderAchievements() {
        const container = document.getElementById('achievementsList');
        if (!container) return;
        const achievements = getAchievements();
        container.innerHTML = '';

        achievements.forEach(a => {
            const progress = Math.min(100, ((a.progress || 0) / a.target) * 100);
            const canClaim = (a.progress || 0) >= a.target && !a.claimed;
            const div = document.createElement('div');
            div.className = 'bg-black/30 border border-gray-700/50 rounded-2xl p-4';
            div.innerHTML = `
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <div class="font-bold">${a.name}</div>
                        <div class="text-[12px] text-gray-400">${a.desc}</div>
                    </div>
                    <div class="text-[12px] text-gray-400">${Math.min(a.target, a.progress || 0)}/${a.target}</div>
                </div>
                <div class="progress-bar mt-3"><div class="progress-fill" style="width:${progress}%"></div></div>
                <div class="mt-3 flex items-center justify-between">
                    <div class="text-sm text-emerald-300">Reward: ${a.reward.toLocaleString()} coins</div>
                    <button class="px-4 py-2 rounded-lg text-sm ${a.claimed ? 'bg-gray-800 text-gray-400 cursor-not-allowed' : canClaim ? 'btn-gold' : 'bg-gray-700 text-gray-300 cursor-not-allowed'}" ${(!canClaim || a.claimed) ? 'disabled' : ''} onclick="claimAchievement('${a.id}')">
                        ${a.claimed ? '‚úì Claimed' : canClaim ? 'Claim' : 'Locked'}
                    </button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // ==================== VIP MISSIONS ====================
    function getMissions() {
        const missions = [
            { id: 'daily_slots_10', name: 'Daily: Play 10 Slots', type: 'slots', target: 10, reward: 500, vipReward: 1000, progress: 0, claimed: false },
            { id: 'daily_win_500', name: 'Daily: Win 500 Coins', type: 'win', target: 500, reward: 300, vipReward: 600, progress: 0, claimed: false },
            { id: 'daily_bingo_5', name: 'Daily: Play 5 Bingo', type: 'bingo', target: 5, reward: 400, vipReward: 800, progress: 0, claimed: false },
            { id: 'weekly_wager_5k', name: 'Weekly: Wager $5,000', type: 'wager', target: 5000, reward: 2000, vipReward: 4000, progress: 0, claimed: false, weekly: true },
            { id: 'vip_referral_1', name: 'VIP: Refer 1 Friend', type: 'referral', target: 1, reward: 0, vipReward: 1500, progress: 0, claimed: false, vipOnly: true }
        ];

        if (!gameState.missions) {
            gameState.missions = missions;
            gameState.missionLastReset = Date.now();
        }

        // Reset daily missions every 24h
        const now = Date.now();
        const dayMs = 24 * 60 * 60 * 1000;
        if (now - gameState.missionLastReset > dayMs) {
            gameState.missions.forEach(m => {
                if (!m.weekly) {
                    m.progress = 0;
                    m.claimed = false;
                }
            });
            gameState.missionLastReset = now;
            saveState();
        }

        return gameState.missions;
    }

    function updateMissionProgress(type, amount) {
        const missions = getMissions();
        missions.forEach(m => {
            if (m.type === type && !m.claimed) {
                m.progress += amount;
                if (m.progress >= m.target) {
                    m.progress = m.target;
                }
            }
        });
        saveState();
    }

    function claimMissionReward(missionId) {
        const missions = getMissions();
        const mission = missions.find(m => m.id === missionId);
        if (!mission || mission.claimed || mission.progress < mission.target) {
            showNotification('Cannot claim this reward yet.', 'error');
            return;
        }

        const isVip = isVipClubActive();
        const reward = isVip ? mission.vipReward : mission.reward;
        
        if (reward === 0) {
            showNotification('Mission completed! Reward will be applied automatically.', 'info');
            mission.claimed = true;
            saveState();
            renderMissions();
            return;
        }

        updateBalance(reward);
        mission.claimed = true;
        showNotification(`Mission completed! +${reward} coins${isVip ? ' (VIP Bonus)' : ''}`, 'success');
        createConfetti();
        saveState();
        renderMissions();
    }

    function renderMissions() {
        const missions = getMissions();
        const container = document.getElementById('missionsList');
        if (!container) return;

        container.innerHTML = '';
        
        missions.forEach(m => {
            if (m.vipOnly && !isVipClubActive()) return;

            const div = document.createElement('div');
            div.className = 'bg-black/30 border border-gray-700/50 rounded-xl p-4 mb-3';
            
            const progress = Math.min(100, (m.progress / m.target) * 100);
            const canClaim = m.progress >= m.target && !m.claimed;
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold">${m.name}</div>
                    <div class="text-sm text-gray-400">${m.progress}/${m.target}</div>
                </div>
                <div class="progress-bar mb-2">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="text-sm text-emerald-300">Reward: ${m.reward} coins${isVipClubActive() && m.vipReward ? ` (VIP: ${m.vipReward})` : ''}</div>
                    <button onclick="claimMissionReward('${m.id}')" 
                        class="px-4 py-2 rounded-lg text-sm ${canClaim ? 'btn-gold' : 'bg-gray-700 cursor-not-allowed'}" 
                        ${!canClaim ? 'disabled' : ''}>
                        ${m.claimed ? '‚úì Claimed' : canClaim ? 'Claim' : 'In Progress'}
                    </button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // ==================== TOURNAMENTS ====================
    function getTournaments() {
        if (!gameState.tournaments) {
            gameState.tournaments = [
                {
                    id: 'weekend_slots',
                    name: 'Weekend Slots Showdown',
                    entryFee: 50,
                    prizePool: 5000,
                    endTime: Date.now() + (3 * 24 * 60 * 60 * 1000), // 3 days
                    active: true,
                    leaderboard: []
                }
            ];
        }
        return gameState.tournaments;
    }

    function joinTournament(tournamentId) {
        const tournaments = getTournaments();
        const tournament = tournaments.find(t => t.id === tournamentId);
        
        if (!tournament || !tournament.active) {
            showNotification('Tournament not available.', 'error');
            return;
        }

        if (Date.now() > tournament.endTime) {
            showNotification('Tournament has ended.', 'error');
            return;
        }

        // Check if already joined
        const existing = tournament.leaderboard.find(l => l.username === (gameState.currentUser?.username || 'Guest'));
        if (existing) {
            showNotification('You already joined this tournament!', 'info');
            return;
        }

        if (gameState.balance < tournament.entryFee) {
            showNotification('Not enough coins for entry fee.', 'error');
            return;
        }

        updateBalance(-tournament.entryFee);
        addWager(tournament.entryFee);

        tournament.leaderboard.push({
            username: gameState.currentUser?.username || 'Guest',
            score: 0,
            joinedAt: Date.now()
        });

        showNotification(`Joined ${tournament.name}! Good luck!`, 'success');
        saveState();
        renderTournaments();
    }

    function updateTournamentScore(winnings) {
        const tournaments = getTournaments();
        const activeTournaments = tournaments.filter(t => t.active && Date.now() < t.endTime);
        
        activeTournaments.forEach(tournament => {
            const player = tournament.leaderboard.find(l => l.username === (gameState.currentUser?.username || 'Guest'));
            if (player) {
                player.score += winnings;
            }
        });

        saveState();
    }

    function renderTournaments() {
        const tournaments = getTournaments();
        const container = document.getElementById('tournamentsList');
        if (!container) return;

        container.innerHTML = '';

        tournaments.forEach(t => {
            const isActive = t.active && Date.now() < t.endTime;
            const timeLeft = Math.max(0, t.endTime - Date.now());
            const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

            const div = document.createElement('div');
            div.className = 'bg-black/30 border border-gray-700/50 rounded-xl p-4 mb-4';

            // Sort leaderboard
            const sorted = [...t.leaderboard].sort((a, b) => b.score - a.score);

            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <div class="font-bold text-lg">${t.name}</div>
                        <div class="text-sm text-gray-400">
                            Entry: ${t.entryFee} coins | Prize: ${t.prizePool} coins
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm ${isActive ? 'text-emerald-400' : 'text-gray-500'}">
                            ${isActive ? `${hoursLeft}h ${minutesLeft}m left` : 'Ended'}
                        </div>
                        ${isActive ? `<button onclick="joinTournament('${t.id}')" class="btn-gold px-4 py-2 rounded-lg text-sm mt-1">Join</button>` : ''}
                    </div>
                </div>
                
                ${sorted.length > 0 ? `
                    <div class="mt-3">
                        <div class="text-xs uppercase text-gray-400 mb-2">Leaderboard</div>
                        <div class="space-y-1">
                            ${sorted.slice(0, 5).map((entry, idx) => `
                                <div class="flex justify-between text-sm ${entry.username === (gameState.currentUser?.username || 'Guest') ? 'text-yellow-400 font-bold' : 'text-gray-300'}">
                                    <span>${idx + 1}. ${entry.username}</span>
                                    <span>${entry.score.toFixed(0)} pts</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '<div class="text-sm text-gray-400 mt-2">No players yet. Be the first to join!</div>'}
            `;
            container.appendChild(div);
        });
    }

    function endTournaments() {
        const tournaments = getTournaments();
        const now = Date.now();
        
        tournaments.forEach(t => {
            if (t.active && now > t.endTime) {
                t.active = false;
                
                // Award prizes to top 3
                const sorted = [...t.leaderboard].sort((a, b) => b.score - a.score);
                const prizes = [t.prizePool * 0.5, t.prizePool * 0.3, t.prizePool * 0.2]; // 50%, 30%, 20%
                
                sorted.slice(0, 3).forEach((player, idx) => {
                    // In a real app, you'd credit their account server-side
                    // For demo, we just show a notification
                    if (player.username === (gameState.currentUser?.username || 'Guest')) {
                        showNotification(`Tournament ended! You placed #${idx + 1}! Prize will be credited.`, 'info');
                    }
                });
            }
        });

        saveState();
    }

    // ==================== REFERRAL SYSTEM ====================
    function getReferralCode() {
        if (!gameState.currentUser) return null;
        return gameState.currentUser.username;
    }

    function getReferralStats() {
        if (!gameState.referralStats) {
            gameState.referralStats = {
                referred: [], // { username, timestamp }
                rewards: 0
            };
        }
        return gameState.referralStats;
    }

    function applyReferral(referredUsername) {
        const code = getReferralCode();
        if (!code || !referredUsername) return;

        if (!gameState.referralHistory) {
            gameState.referralHistory = [];
        }

        // Check if this referral already exists
        if (gameState.referralHistory.find(r => r.referred === referredUsername)) {
            return;
        }

        // Record the referral
        gameState.referralHistory.push({
            referrer: code,
            referred: referredUsername,
            timestamp: Date.now()
        });

        // Credit referrer (500 coins + 50 VIP XP)
        const stats = getReferralStats();
        stats.referred.push({ username: referredUsername, timestamp: Date.now() });
        stats.rewards += 500;
        
        // Apply immediately if this is the current user
        if (gameState.currentUser && gameState.currentUser.username === code) {
            updateBalance(500);
            gameState.vipXP += 50;
            updateVipUI();
            showNotification(`Referral success! +500 coins +50 VIP XP`, 'success');
            createConfetti();
        }

        saveState();
    }

    function generateReferralLink() {
        const code = getReferralCode();
        if (!code) return null;
        
        // In a real app, this would be your domain: https://yourapp.com?ref=CODE
        return `${window.location.origin}${window.location.pathname}?ref=${encodeURIComponent(code)}`;
    }

    function shareReferral() {
        const link = generateReferralLink();
        if (!link) {
            showNotification('Please login to generate a referral link.', 'error');
            return;
        }

        // Copy to clipboard
        navigator.clipboard.writeText(link).then(() => {
            showNotification('Referral link copied to clipboard!', 'success');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = link;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Referral link copied to clipboard!', 'success');
        });
    }

    function checkForReferral() {
        const urlParams = new URLSearchParams(window.location.search);
        const ref = urlParams.get('ref');
        if (!ref) return;

        // Store pending referral until account exists
        if (!gameState.pendingRef) {
            gameState.pendingRef = ref;
            saveState();
        }
    }

    async function applyReferralIfEligible() {
        if (!supabaseClient || !gameState.session?.user) return;
        const ref = gameState.pendingRef;
        if (!ref) return;

        // Don't self-refer: compare with username if known
        const myUsername = gameState.currentUser?.username;
        if (myUsername && myUsername.toLowerCase() === String(ref).toLowerCase()) {
            gameState.pendingRef = null;
            saveState();
            return;
        }

        try {
            // This expects:
            // - profiles table: id, username
            // - referrals table: id, referrer_id, referred_id, created_at
            const { data: referrer, error: refErr } = await supabaseClient
                .from('profiles')
                .select('id, username')
                .eq('username', ref)
                .maybeSingle();

            if (refErr) throw refErr;
            if (!referrer?.id) return;

            // Ensure we haven't already used a referral
            const { data: existing } = await supabaseClient
                .from('referrals')
                .select('id')
                .eq('referred_id', gameState.session.user.id)
                .maybeSingle();

            if (existing?.id) {
                gameState.pendingRef = null;
                saveState();
                return;
            }

            // Insert referral
            const { error: insErr } = await supabaseClient
                .from('referrals')
                .insert({ referrer_id: referrer.id, referred_id: gameState.session.user.id });
            if (insErr) throw insErr;

            // Reward both sides (client-side update + sync). In production, do this in a Supabase Edge Function.
            // Referrer: +500 coins, +50 VIP XP
            // Referred: +1000 coins
            updateMissionProgress('referral', 1);
            // VIP-only mission will now be claimable if VIP is active
            renderMissions();
            await supabaseClient.rpc('apply_referral_rewards', {
                p_referrer_id: referrer.id,
                p_referred_id: gameState.session.user.id
            }).catch(() => null);

            // If you don't have the RPC, we still grant locally (and sync).
            updateBalance(1000);
            gameState.vipXP += 0;
            updateVipUI();
            scheduleProfileSync();

            // Also increment local referral mission progress (client side)
            updateMissionProgress('referral', 1);
            renderMissions();

            showNotification(`Referral applied! +1000 coins. Referrer: ${referrer.username}`, 'success');
        } catch (e) {
            console.warn('Referral apply failed:', e?.message || e);
        } finally {
            gameState.pendingRef = null;
            saveState();
        }
    }

    // ==================== GAME HOOKS FOR MISSIONS & TOURNAMENTS ====================
    // Override existing game functions to track progress

    const originalSpinSlots = spinSlots;
    spinSlots = async function() {
        const result = await originalSpinSlots.call(this);
        updateMissionProgress('slots', 1);
        updateAchievementProgress('slots', 1);
        return result;
    };

    const originalPlayBingo = playBingo;
    playBingo = function() {
        const result = originalPlayBingo.call(this);
        updateMissionProgress('bingo', 1);
        return result;
    };

    // Hook NM and VIP slots into missions/achievements too
    const originalSpinNmSlots = spinNmSlots;
    spinNmSlots = async function() {
        const result = await originalSpinNmSlots.call(this);
        updateMissionProgress('slots', 1);
        updateAchievementProgress('slots', 1);
        return result;
    };

    const originalSpinVipSlots = spinVipSlots;
    spinVipSlots = async function() {
        const result = await originalSpinVipSlots.call(this);
        updateMissionProgress('slots', 1);
        updateAchievementProgress('slots', 1);
        return result;
    };

    // Track winnings for missions and tournaments
    const originalUpdateBalance = updateBalance;
    updateBalance = function(amount) {
        if (amount > 0) {
            updateMissionProgress('win', amount);
            updateTournamentScore(amount);
            updateAchievementProgress('win', amount);
        }
        originalUpdateBalance.call(this, amount);
        updateStorePrompts();
    };

    // Track wagers
    const originalAddWager = addWager;
    addWager = function(amount) {
        updateMissionProgress('wager', amount);
        updateAchievementProgress('wager', amount);
        originalAddWager.call(this, amount);
    };

    async function ensureProfileExists(uid, username, email) {
        if (!supabaseClient) return;
        // Try read
        const { data: existing } = await supabaseClient
            .from('profiles')
            .select('id')
            .eq('id', uid)
            .maybeSingle();

        if (existing?.id) return;

        // Create base profile
        const { error } = await supabaseClient
            .from('profiles')
            .insert({
                id: uid,
                username,
                email,
                coins: Math.floor(gameState.balance),
                vip_level: 0,
                vip_xp: 0,
                total_wagered: 0,
                vip_active: false,
                vip_expires_at: null,
                ad_free: false,
                daily_streak: 1,
                last_claim: null,
                free_spins: 3
            });

        if (error) {
            console.warn('Profile create failed:', error.message);
        }
    }

    async function loadProfileFromSupabase(uid) {
        if (!supabaseClient) return;
        const { data, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', uid)
            .single();
        if (error) {
            console.warn('Profile load failed:', error.message);
            return;
        }

        gameState.userProfile = data;

        // Apply remote state into local state
        if (typeof data.coins === 'number') gameState.balance = data.coins;
        if (typeof data.vip_xp === 'number') gameState.vipXP = data.vip_xp;
        if (typeof data.total_wagered === 'number') gameState.totalWagered = data.total_wagered;
        if (typeof data.daily_streak === 'number') gameState.dailyStreak = data.daily_streak;
        if (data.last_claim) gameState.lastClaim = data.last_claim;
        if (typeof data.free_spins === 'number') gameState.freeSpins = data.free_spins;

        if (data.username) {
            gameState.currentUser = { username: data.username, email: data.email || null };
        }

        // VIP
        if (data.vip_active && data.vip_expires_at) {
            const exp = new Date(data.vip_expires_at).getTime();
            gameState.vipClub.active = Date.now() < exp;
            gameState.vipClub.expiresAt = exp;
            gameState.vipClub.adFree = !!data.ad_free;
        }

        // Refresh UI
        document.getElementById('balance').textContent = gameState.balance.toFixed(2);
        updateVipUI();
        updateAuthUI();
        refreshVipClubUI();
        updateDailyBonusUI();
        saveState();
    }

    async function bootstrapSupabaseSession() {
        if (!supabaseClient) return;

        // Handle magic links / OAuth redirects
        try {
            await supabaseClient.auth.exchangeCodeForSession(window.location.href);
        } catch (_) {
            // no-op
        }

        const { data: { session } } = await supabaseClient.auth.getSession();
        gameState.session = session;

        // Subscribe to auth changes
        supabaseClient.auth.onAuthStateChange(async (_event, newSession) => {
            gameState.session = newSession;
            saveState();
            if (newSession?.user?.id) {
                // Load profile on sign-in
                const uname = document.getElementById('authUsername')?.value?.trim() || gameState.currentUser?.username || 'Player';
                const em = newSession.user.email || gameState.currentUser?.email || null;
                await ensureProfileExists(newSession.user.id, uname, em);
                await loadProfileFromSupabase(newSession.user.id);
                await applyReferralIfEligible();
            } else {
                updateAuthUI();
                refreshVipClubUI();
            }
        });

        if (session?.user?.id) {
            await loadProfileFromSupabase(session.user.id);
            await applyReferralIfEligible();
        }
    }

    function updateStorePrompts() {
        const prompt = document.getElementById('lowBalancePrompt');
        if (!prompt) return;
        const low = Number(gameState.balance || 0) < 150;
        prompt.classList.toggle('hidden', !low);
    }

    // ==================== INIT ====================
    async function init() {
        document.getElementById('balance').textContent = Number(gameState.balance || 0).toFixed(2);

        createFortuneWheel();
        newBingoCard();

        if (gameState.lastLogin !== new Date().toDateString()) {
            gameState.lastLogin = new Date().toDateString();
            saveState();
        }

        updateVipUI();
        updateAuthUI();
        refreshVipClubUI();
        updateDailyBonusUI();

        // Capture referral attribution early
        checkForReferral();

        // Bootstrap Supabase session (magic links, persisted sessions)
        try {
            await bootstrapSupabaseSession();
        } catch (e) {
            console.warn('Supabase bootstrap skipped:', e?.message || e);
        }

        // Format card number input
        const cardNumber = document.getElementById('cardNumber');
        if (cardNumber) {
            cardNumber.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
                let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formatted;
            });
        }

        // Format expiry input
        const cardExpiry = document.getElementById('cardExpiry');
        if (cardExpiry) {
            cardExpiry.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) value = value.slice(0, 2) + '/' + value.slice(2);
                e.target.value = value;
            });
        }

        // Tick: coin regen
        setInterval(coinRegenTick, 1500);
        coinRegenTick();

        // Check for tournament end
        setInterval(endTournaments, 60000); // Check every minute

        // Render meta systems
        renderMissions();
        renderAchievements();
        renderTournaments();
        updateStorePrompts();

        console.log('üé∞ Royal Fortune Casino initialized!');
    }

    init();
</script>

</body>
</html>
